<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Maintenance Management - VeloRent</title>
    <link rel="stylesheet" href="/css/auth-styles.css">
    <style>
        /* Enhanced luxury styling for maintenance management */
        :root {
            --luxury-gold: #d4af37;
            --luxury-dark: #1a1a1a;
            --luxury-darker: #0f0f0f;
            --luxury-white: #ffffff;
            --luxury-gray: #f8f8f8;
            --luxury-border: #e0e0e0;
            --success-green: #28a745;
            --warning-orange: #ffc107;
            --danger-red: #dc3545;
            --info-blue: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--luxury-darker) 0%, var(--luxury-dark) 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: var(--luxury-white);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .header h1 {
            color: var(--luxury-gold);
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
        }

        .header p {
            text-align: center;
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 25px;
            color: var(--luxury-white);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover,
        .nav-tab.active {
            background: var(--luxury-gold);
            color: var(--luxury-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--luxury-gold);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .content-section.active {
            display: block;
        }

        /* Forms */
        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--luxury-gold);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--luxury-white);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--luxury-gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Enhanced dropdown styling for better readability */
        .form-control select,
        select.form-control {
            background: rgba(26, 26, 26, 0.95);
            color: var(--luxury-white);
            border: 2px solid rgba(212, 175, 55, 0.4);
            font-weight: 500;
            text-shadow: none;
        }

        .form-control select option,
        select.form-control option {
            background: var(--luxury-darker);
            color: var(--luxury-white);
            padding: 10px 15px;
            font-weight: 500;
            border: none;
            text-shadow: none;
        }

        .form-control select option:checked,
        select.form-control option:checked {
            background: var(--luxury-gold);
            color: var(--luxury-dark);
            font-weight: 600;
        }

        .form-control select option:hover,
        select.form-control option:hover {
            background: rgba(212, 175, 55, 0.2);
            color: var(--luxury-white);
        }

        /* Specific styling for vehicle selector dropdowns */
        .vehicle-selector-dropdown {
            background: rgba(15, 15, 15, 0.98) !important;
            color: #ffffff !important;
            border: 2px solid rgba(212, 175, 55, 0.5) !important;
            font-size: 1rem !important;
            font-weight: 500 !important;
            line-height: 1.5 !important;
            text-shadow: none !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .vehicle-selector-dropdown option {
            background: #0f0f0f !important;
            color: #ffffff !important;
            padding: 12px 16px !important;
            font-weight: 500 !important;
            border: none !important;
            text-shadow: none !important;
            line-height: 1.4 !important;
        }

        .vehicle-selector-dropdown option:checked {
            background: #d4af37 !important;
            color: #1a1a1a !important;
            font-weight: 600 !important;
        }

        /* Custom dropdown arrow */
        .vehicle-selector-dropdown {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23d4af37' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px !important;
        }

        /* Focus state for better visibility */
        .vehicle-selector-dropdown:focus {
            border-color: var(--luxury-gold) !important;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3) !important;
            outline: none !important;
        }

        /* Webkit specific fixes for Safari/Chrome */
        .vehicle-selector-dropdown::-webkit-scrollbar {
            width: 8px;
        }

        .vehicle-selector-dropdown::-webkit-scrollbar-track {
            background: var(--luxury-darker);
        }

        .vehicle-selector-dropdown::-webkit-scrollbar-thumb {
            background: var(--luxury-gold);
            border-radius: 4px;
        }

        .vehicle-selector-dropdown::-webkit-scrollbar-thumb:hover {
            background: #c49c2f;
        }

        /* Additional fixes for text clarity and dropdown behavior */
        .form-control.vehicle-selector-dropdown {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            letter-spacing: 0.3px;
            word-spacing: 1px;
        }

        /* Ensure dropdown list has proper styling when opened */
        .vehicle-selector-dropdown:focus option,
        .vehicle-selector-dropdown:active option {
            background: #0f0f0f !important;
            color: #ffffff !important;
        }

        .vehicle-selector-dropdown:focus option:hover,
        .vehicle-selector-dropdown:active option:hover {
            background: rgba(212, 175, 55, 0.3) !important;
            color: #ffffff !important;
        }

        /* Fix for any potential text shadow issues */
        .vehicle-selector-dropdown,
        .vehicle-selector-dropdown option {
            text-shadow: none !important;
            filter: none !important;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--luxury-gold);
            color: var(--luxury-dark);
        }

        .btn-primary:hover {
            background: #c49c2f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .btn-success {
            background: var(--success-green);
            color: var(--luxury-white);
        }

        .btn-warning {
            background: var(--warning-orange);
            color: var(--luxury-dark);
        }

        .btn-danger {
            background: var(--danger-red);
            color: var(--luxury-white);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Back button styling */
        .btn-back {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(212, 175, 55, 0.5) !important;
            color: var(--luxury-white) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: rgba(212, 175, 55, 0.2) !important;
            border-color: var(--luxury-gold) !important;
            transform: translateX(-3px);
            box-shadow: 0 3px 10px rgba(212, 175, 55, 0.2);
        }

        .btn-back i {
            transition: transform 0.3s ease;
        }

        .btn-back:hover i {
            transform: translateX(-2px);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
        }

        .maintenance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .maintenance-table th,
        .maintenance-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .maintenance-table th {
            background: rgba(212, 175, 55, 0.2);
            color: var(--luxury-gold);
            font-weight: 600;
        }

        .maintenance-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-completed {
            background: var(--success-green);
            color: var(--luxury-white);
        }

        .status-scheduled {
            background: var(--info-blue);
            color: var(--luxury-white);
        }

        .status-overdue {
            background: var(--danger-red);
            color: var(--luxury-white);
        }

        /* Loading and Messages */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--luxury-gold);
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message-success {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success-green);
            border: 1px solid var(--success-green);
        }

        .message-error {
            background: rgba(220, 53, 69, 0.2);
            color: var(--danger-red);
            border: 1px solid var(--danger-red);
        }

        /* Vehicle Selector */
        .vehicle-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .vehicle-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .vehicle-card:hover,
        .vehicle-card.selected {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--luxury-gold);
            transform: translateY(-2px);
        }

        .vehicle-info {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .vehicle-reg {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Vehicle Preview */
        .vehicle-preview {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            display: none;
        }

        .vehicle-preview.show {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .vehicle-preview-content {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .vehicle-preview-image {
            width: 80px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(212, 175, 55, 0.3);
        }

        .vehicle-preview-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(212, 175, 55, 0.2);
            color: var(--luxury-gold);
            font-size: 1.5rem;
        }

        .vehicle-preview-details {
            flex: 1;
        }

        .vehicle-preview-name {
            font-weight: 600;
            color: var(--luxury-gold);
            margin-bottom: 3px;
        }

        .vehicle-preview-info {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Fix for overlapping text and ensure proper z-index */
        .form-group {
            position: relative;
            z-index: 1;
        }

        .vehicle-selector-dropdown {
            position: relative;
            z-index: 10;
        }

        .vehicle-preview {
            position: relative;
            z-index: 5;
        }

        /* Ensure proper text rendering */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Additional text clarity fixes */
        .vehicle-selector-dropdown {
            text-rendering: optimizeLegibility;
            font-feature-settings: "liga", "kern";
        }

        .vehicle-selector-dropdown option {
            font-feature-settings: "liga", "kern";
            text-rendering: optimizeLegibility;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }

            .stats-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <button onclick="goBackToDashboard()" class="btn btn-back" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(212, 175, 55, 0.5); color: var(--luxury-white); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </button>
                <div style="flex: 1;"></div>
            </div>
            <h1>🔧 Vehicle Maintenance Management</h1>
            <p>Schedule and track vehicle maintenance for optimal fleet performance</p>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">0</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedRecords">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="scheduledRecords">0</div>
                <div class="stat-label">Scheduled</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCost">RS 0</div>
                <div class="stat-label">Total Cost</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showSection('overview')">Overview</div>
            <div class="nav-tab" onclick="showSection('schedule')">Schedule Maintenance</div>
            <div class="nav-tab" onclick="showSection('log')">Log Maintenance</div>
            <div class="nav-tab" onclick="showSection('upcoming')">Upcoming</div>
            <div class="nav-tab" onclick="showSection('overdue')">Overdue</div>
        </div>

        <!-- Messages -->
        <div id="messageContainer"></div>

        <!-- Overview Section -->
        <div id="overview" class="content-section active">
            <h2>📊 All Maintenance Records</h2>
            <div class="table-container">
                <table class="maintenance-table">
                    <thead>
                        <tr>
                            <th>Vehicle</th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Cost</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="overviewTableBody">
                        <tr>
                            <td colspan="6" class="loading">Loading maintenance records...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Schedule Maintenance Section -->
        <div id="schedule" class="content-section">
            <h2>📅 Schedule Future Maintenance</h2>
            <div class="form-container">
                <form id="scheduleMaintenanceForm">
                    <div class="form-group">
                        <label for="scheduleVehicleId">Select Vehicle:</label>
                        <select id="scheduleVehicleId" class="form-control" required>
                            <option value="">Loading vehicles...</option>
                        </select>
                        <div id="scheduleVehiclePreview" class="vehicle-preview">
                            <div class="vehicle-preview-content">
                                <div id="scheduleVehicleImage" class="vehicle-preview-image placeholder">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div class="vehicle-preview-details">
                                    <div id="scheduleVehicleName" class="vehicle-preview-name"></div>
                                    <div id="scheduleVehicleInfo" class="vehicle-preview-info"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="scheduleDate">Scheduled Date:</label>
                        <input type="date" id="scheduleDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="scheduleDescription">Maintenance Description:</label>
                        <textarea id="scheduleDescription" class="form-control" rows="3" 
                                placeholder="e.g., Oil change, Brake inspection, Tire rotation..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">📅 Schedule Maintenance</button>
                </form>
            </div>
        </div>

        <!-- Log Maintenance Section -->
        <div id="log" class="content-section">
            <h2>📝 Log Completed Maintenance</h2>
            <div class="form-container">
                <form id="logMaintenanceForm">
                    <div class="form-group">
                        <label for="logVehicleId">Select Vehicle:</label>
                        <select id="logVehicleId" class="form-control" required>
                            <option value="">Loading vehicles...</option>
                        </select>
                        <div id="logVehiclePreview" class="vehicle-preview">
                            <div class="vehicle-preview-content">
                                <div id="logVehicleImage" class="vehicle-preview-image placeholder">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div class="vehicle-preview-details">
                                    <div id="logVehicleName" class="vehicle-preview-name"></div>
                                    <div id="logVehicleInfo" class="vehicle-preview-info"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="logDate">Maintenance Date:</label>
                        <input type="date" id="logDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="logDescription">Maintenance Description:</label>
                        <textarea id="logDescription" class="form-control" rows="3" 
                                placeholder="e.g., Oil change completed, New brake pads installed..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="logCost">Cost (RS):</label>
                        <input type="number" id="logCost" class="form-control" step="0.01" min="0" 
                               placeholder="0.00" required>
                    </div>
                    <button type="submit" class="btn btn-success">💰 Log Maintenance</button>
                </form>
            </div>
        </div>

        <!-- Upcoming Maintenance Section -->
        <div id="upcoming" class="content-section">
            <h2>⏰ Upcoming Maintenance</h2>
            <div class="table-container">
                <table class="maintenance-table">
                    <thead>
                        <tr>
                            <th>Vehicle</th>
                            <th>Scheduled Date</th>
                            <th>Description</th>
                            <th>Days Until Due</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="upcomingTableBody">
                        <tr>
                            <td colspan="5" class="loading">Loading upcoming maintenance...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Overdue Maintenance Section -->
        <div id="overdue" class="content-section">
            <h2>⚠️ Overdue Maintenance</h2>
            <div class="table-container">
                <table class="maintenance-table">
                    <thead>
                        <tr>
                            <th>Vehicle</th>
                            <th>Scheduled Date</th>
                            <th>Description</th>
                            <th>Days Overdue</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="overdueTableBody">
                        <tr>
                            <td colspan="5" class="loading">Loading overdue maintenance...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Complete Maintenance Modal -->
    <div id="completeMaintenanceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--luxury-dark); padding: 30px; border-radius: 15px; border: 1px solid var(--luxury-gold); min-width: 400px;">
            <h3 style="color: var(--luxury-gold); margin-bottom: 20px;">Complete Maintenance</h3>
            <form id="completeMaintenanceForm">
                <input type="hidden" id="completeMaintenanceId">
                <div class="form-group">
                    <label for="completeCost">Maintenance Cost (RS):</label>
                    <input type="number" id="completeCost" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="closeCompleteModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Complete Maintenance</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let vehicles = [];
        let maintenanceRecords = [];
        const token = localStorage.getItem("token");

        // Check authentication and role
        document.addEventListener("DOMContentLoaded", function() {
            if (!token) {
                window.location.href = "/login?message=" + encodeURIComponent("Please log in to access this page") + "&type=error";
                return;
            }

            const userRole = localStorage.getItem("userRole");
            if (!userRole || !(userRole.includes("FLEET_MANAGER") || userRole.includes("FLEETMANAGER"))) {
                window.location.href = "/dashboard?message=" + encodeURIComponent("You do not have permission to access this page") + "&type=error";
                return;
            }

            // Initialize the page
            initializePage();
        });

        // Initialize page data
        async function initializePage() {
            try {
                await Promise.all([
                    loadVehicles(),
                    loadMaintenanceStats(),
                    loadAllMaintenance()
                ]);
            } catch (error) {
                console.error('Error initializing page:', error);
                showMessage('Error loading page data', 'error');
            }
        }

        // Load vehicles for dropdowns
        async function loadVehicles() {
            try {
                const response = await fetch('/api/vehicles', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    vehicles = await response.json();
                    populateVehicleSelectors();
                } else {
                    throw new Error('Failed to load vehicles');
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showMessage('Error loading vehicles', 'error');
            }
        }

        // Populate vehicle selector dropdowns with images
        function populateVehicleSelectors() {
            const selectors = ['scheduleVehicleId', 'logVehicleId'];
            
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '<option value="" style="color: rgba(255,255,255,0.8);">Select a vehicle...</option>';
                select.className = 'form-control vehicle-selector-dropdown';
                
                vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.vehicleId;
                    option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.registrationNumber})`;
                    option.setAttribute('data-image', vehicle.imageUrl || '');
                    option.setAttribute('data-make', vehicle.make);
                    option.setAttribute('data-model', vehicle.model);
                    option.setAttribute('data-year', vehicle.year);
                    option.setAttribute('data-registration', vehicle.registrationNumber);
                    option.style.cssText = 'background: #0f0f0f !important; color: #ffffff !important; padding: 8px 12px;';
                    select.appendChild(option);
                });
                
                // Add change event listener to show vehicle preview
                select.addEventListener('change', function() {
                    showVehiclePreview(this, selectorId);
                });

                // Add focus/blur event listeners for better visual feedback
                select.addEventListener('focus', function() {
                    this.style.borderColor = '#d4af37';
                    this.style.boxShadow = '0 0 0 3px rgba(212, 175, 55, 0.3)';
                });

                select.addEventListener('blur', function() {
                    this.style.borderColor = 'rgba(212, 175, 55, 0.5)';
                    this.style.boxShadow = 'none';
                });
            });
        }

        // Load maintenance statistics
        async function loadMaintenanceStats() {
            try {
                const response = await fetch('/api/fleet/maintenance/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                } else {
                    throw new Error('Failed to load maintenance stats');
                }
            } catch (error) {
                console.error('Error loading maintenance stats:', error);
                // Set default values on error
                updateStatsDisplay({
                    totalRecords: 0,
                    completedRecords: 0,
                    scheduledRecords: 0,
                    totalCost: 0
                });
            }
        }

        // Update statistics display
        function updateStatsDisplay(stats) {
            document.getElementById('totalRecords').textContent = stats.totalRecords || 0;
            document.getElementById('completedRecords').textContent = stats.completedRecords || 0;
            document.getElementById('scheduledRecords').textContent = stats.scheduledRecords || 0;
            document.getElementById('totalCost').textContent = `RS ${(stats.totalCost || 0).toFixed(2)}`;
        }

        // Load all maintenance records
        async function loadAllMaintenance() {
            try {
                const response = await fetch('/api/fleet/maintenance', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    maintenanceRecords = await response.json();
                    populateMaintenanceTable('overviewTableBody', maintenanceRecords);
                } else {
                    throw new Error('Failed to load maintenance records');
                }
            } catch (error) {
                console.error('Error loading maintenance records:', error);
                document.getElementById('overviewTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: var(--danger-red);">Error loading maintenance records</td></tr>';
            }
        }

        // Load upcoming maintenance
        async function loadUpcomingMaintenance() {
            try {
                const response = await fetch('/api/fleet/maintenance/upcoming', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const records = await response.json();
                    populateUpcomingTable(records);
                } else {
                    throw new Error('Failed to load upcoming maintenance');
                }
            } catch (error) {
                console.error('Error loading upcoming maintenance:', error);
                document.getElementById('upcomingTableBody').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; color: var(--danger-red);">Error loading upcoming maintenance</td></tr>';
            }
        }

        // Load overdue maintenance
        async function loadOverdueMaintenance() {
            try {
                const response = await fetch('/api/fleet/maintenance/overdue', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const records = await response.json();
                    populateOverdueTable(records);
                } else {
                    throw new Error('Failed to load overdue maintenance');
                }
            } catch (error) {
                console.error('Error loading overdue maintenance:', error);
                document.getElementById('overdueTableBody').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; color: var(--danger-red);">Error loading overdue maintenance</td></tr>';
            }
        }

        // Populate maintenance table
        function populateMaintenanceTable(tableBodyId, records) {
            const tbody = document.getElementById(tableBodyId);
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; opacity: 0.7;">No maintenance records found</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>
                        <div class="vehicle-info">${record.vehicleMake} ${record.vehicleModel}</div>
                        <div class="vehicle-reg">${record.vehicleRegistrationNumber}</div>
                    </td>
                    <td>${formatDate(record.maintenanceDate)}</td>
                    <td>${record.description}</td>
                    <td>${record.cost ? `RS ${record.cost.toFixed(2)}` : '-'}</td>
                    <td><span class="status-badge status-${record.status.toLowerCase()}">${record.status}</span></td>
                    <td>
                        ${record.status === 'Scheduled' ? 
                            `<button class="btn btn-success btn-sm" onclick="openCompleteModal(${record.maintenanceId})">Complete</button>` : 
                            ''
                        }
                        <button class="btn btn-danger btn-sm" onclick="deleteMaintenance(${record.maintenanceId})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Populate upcoming maintenance table
        function populateUpcomingTable(records) {
            const tbody = document.getElementById('upcomingTableBody');
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.7;">No upcoming maintenance scheduled</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(record => {
                const daysUntil = Math.ceil((new Date(record.maintenanceDate) - new Date()) / (1000 * 60 * 60 * 24));
                return `
                    <tr>
                        <td>
                            <div class="vehicle-info">${record.vehicleMake} ${record.vehicleModel}</div>
                            <div class="vehicle-reg">${record.vehicleRegistrationNumber}</div>
                        </td>
                        <td>${formatDate(record.maintenanceDate)}</td>
                        <td>${record.description}</td>
                        <td>${daysUntil} days</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="openCompleteModal(${record.maintenanceId})">Complete</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMaintenance(${record.maintenanceId})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Populate overdue maintenance table
        function populateOverdueTable(records) {
            const tbody = document.getElementById('overdueTableBody');
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.7;">No overdue maintenance found</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(record => {
                const daysOverdue = Math.ceil((new Date() - new Date(record.maintenanceDate)) / (1000 * 60 * 60 * 24));
                return `
                    <tr>
                        <td>
                            <div class="vehicle-info">${record.vehicleMake} ${record.vehicleModel}</div>
                            <div class="vehicle-reg">${record.vehicleRegistrationNumber}</div>
                        </td>
                        <td>${formatDate(record.maintenanceDate)}</td>
                        <td>${record.description}</td>
                        <td style="color: var(--danger-red); font-weight: 600;">${daysOverdue} days</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="openCompleteModal(${record.maintenanceId})">Complete</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMaintenance(${record.maintenanceId})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Show section
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load specific data for the section
            if (sectionName === 'upcoming') {
                loadUpcomingMaintenance();
            } else if (sectionName === 'overdue') {
                loadOverdueMaintenance();
            }
        }

        // Schedule maintenance form submission
        document.getElementById('scheduleMaintenanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                vehicleId: parseInt(document.getElementById('scheduleVehicleId').value),
                maintenanceDate: document.getElementById('scheduleDate').value,
                description: document.getElementById('scheduleDescription').value
            };

            try {
                const response = await fetch('/api/fleet/maintenance', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showMessage('Maintenance scheduled successfully!', 'success');
                    this.reset();
                    await Promise.all([
                        loadMaintenanceStats(),
                        loadAllMaintenance()
                    ]);
                } else {
                    throw new Error('Failed to schedule maintenance');
                }
            } catch (error) {
                console.error('Error scheduling maintenance:', error);
                showMessage('Error scheduling maintenance', 'error');
            }
        });

        // Log maintenance form submission
        document.getElementById('logMaintenanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                vehicleId: parseInt(document.getElementById('logVehicleId').value),
                maintenanceDate: document.getElementById('logDate').value,
                description: document.getElementById('logDescription').value,
                cost: parseFloat(document.getElementById('logCost').value)
            };

            try {
                const response = await fetch('/api/fleet/maintenance', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showMessage('Maintenance logged successfully!', 'success');
                    this.reset();
                    await Promise.all([
                        loadMaintenanceStats(),
                        loadAllMaintenance()
                    ]);
                } else {
                    throw new Error('Failed to log maintenance');
                }
            } catch (error) {
                console.error('Error logging maintenance:', error);
                showMessage('Error logging maintenance', 'error');
            }
        });

        // Complete maintenance modal functions
        function openCompleteModal(maintenanceId) {
            document.getElementById('completeMaintenanceId').value = maintenanceId;
            document.getElementById('completeMaintenanceModal').style.display = 'block';
        }

        function closeCompleteModal() {
            document.getElementById('completeMaintenanceModal').style.display = 'none';
            document.getElementById('completeMaintenanceForm').reset();
        }

        // Complete maintenance form submission
        document.getElementById('completeMaintenanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const maintenanceId = document.getElementById('completeMaintenanceId').value;
            const cost = parseFloat(document.getElementById('completeCost').value);

            try {
                const response = await fetch(`/api/fleet/maintenance/${maintenanceId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cost })
                });

                if (response.ok) {
                    showMessage('Maintenance completed successfully!', 'success');
                    closeCompleteModal();
                    await Promise.all([
                        loadMaintenanceStats(),
                        loadAllMaintenance(),
                        // Reload current section if it's upcoming or overdue
                        ...(document.getElementById('upcoming').classList.contains('active') ? [loadUpcomingMaintenance()] : []),
                        ...(document.getElementById('overdue').classList.contains('active') ? [loadOverdueMaintenance()] : [])
                    ]);
                } else {
                    throw new Error('Failed to complete maintenance');
                }
            } catch (error) {
                console.error('Error completing maintenance:', error);
                showMessage('Error completing maintenance', 'error');
            }
        });

        // Delete maintenance
        async function deleteMaintenance(maintenanceId) {
            if (!confirm('Are you sure you want to delete this maintenance record?')) {
                return;
            }

            try {
                const response = await fetch(`/api/fleet/maintenance/${maintenanceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showMessage('Maintenance record deleted successfully!', 'success');
                    await Promise.all([
                        loadMaintenanceStats(),
                        loadAllMaintenance(),
                        // Reload current section if it's upcoming or overdue
                        ...(document.getElementById('upcoming').classList.contains('active') ? [loadUpcomingMaintenance()] : []),
                        ...(document.getElementById('overdue').classList.contains('active') ? [loadOverdueMaintenance()] : [])
                    ]);
                } else {
                    throw new Error('Failed to delete maintenance record');
                }
            } catch (error) {
                console.error('Error deleting maintenance:', error);
                showMessage('Error deleting maintenance record', 'error');
            }
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Close modal when clicking outside
        document.getElementById('completeMaintenanceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCompleteModal();
            }
        });

        // Show vehicle preview when selected
        function showVehiclePreview(selectElement, selectorId) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const previewId = selectorId === 'scheduleVehicleId' ? 'scheduleVehiclePreview' : 'logVehiclePreview';
            const imageId = selectorId === 'scheduleVehicleId' ? 'scheduleVehicleImage' : 'logVehicleImage';
            const nameId = selectorId === 'scheduleVehicleId' ? 'scheduleVehicleName' : 'logVehicleName';
            const infoId = selectorId === 'scheduleVehicleId' ? 'scheduleVehicleInfo' : 'logVehicleInfo';
            
            const preview = document.getElementById(previewId);
            const imageElement = document.getElementById(imageId);
            const nameElement = document.getElementById(nameId);
            const infoElement = document.getElementById(infoId);
            
            if (selectElement.value && selectedOption) {
                const imageUrl = selectedOption.getAttribute('data-image');
                const make = selectedOption.getAttribute('data-make');
                const model = selectedOption.getAttribute('data-model');
                const year = selectedOption.getAttribute('data-year');
                const registration = selectedOption.getAttribute('data-registration');
                
                // Update image
                if (imageUrl && imageUrl.trim() !== '') {
                    imageElement.innerHTML = '';
                    imageElement.classList.remove('placeholder');
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = `${make} ${model}`;
                    img.className = 'vehicle-preview-image';
                    img.onerror = function() {
                        imageElement.innerHTML = '<i class="fas fa-car"></i>';
                        imageElement.classList.add('placeholder');
                    };
                    imageElement.appendChild(img);
                } else {
                    imageElement.innerHTML = '<i class="fas fa-car"></i>';
                    imageElement.classList.add('placeholder');
                }
                
                // Update details
                nameElement.textContent = `${make} ${model}`;
                infoElement.textContent = `${year} • ${registration}`;
                
                // Show preview with animation
                preview.classList.add('show');
            } else {
                // Hide preview
                preview.classList.remove('show');
            }
        }

        // Navigate back to fleet manager dashboard
        function goBackToDashboard() {
            // Try to go back to the previous page if it was the dashboard
            if (document.referrer && (document.referrer.includes('/fleet-manager') || document.referrer.includes('/dashboard'))) {
                window.history.back();
            } else {
                // Otherwise, navigate directly to the fleet manager dashboard
                window.location.href = '/fleet-manager/dashboard';
            }
        }

        // Set today as default date for forms
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('logDate').value = today;
        });
    </script>
</body>
</html>