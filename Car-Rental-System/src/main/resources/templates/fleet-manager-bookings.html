<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fleet Manager | Bookings</title>
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
  <meta name="_csrf_parameter" th:content="${_csrf.parameterName}">
  <!-- CSRF meta for form fallback -->
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
  <meta name="_csrf_parameter" th:content="${_csrf.parameterName}">
  <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/css/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="/css/DataTables/datatables.min.css" />
  <link rel="stylesheet" href="/css/luxury-theme.css" />
  <style>
    body{background:var(--gradient-luxury);color:var(--text-luxury-light);padding-top:130px}
    .navbar-luxury{background:linear-gradient(135deg,var(--luxury-black),var(--luxury-charcoal),var(--luxury-black))!important;border-bottom:2px solid var(--luxury-gold)}
    .page-title{color:var(--luxury-gold);font-family:var(--font-luxury-primary);font-weight:700}
    .lux-card{background:linear-gradient(135deg,var(--luxury-charcoal),var(--luxury-black));border:1px solid rgba(212,175,55,.25);border-radius:12px;box-shadow:var(--shadow-luxury)}
    .btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);border:none}
    table.dataTable tbody tr:hover{background:rgba(212,175,55,0.06)}
    .badge{padding:4px 8px;border-radius:12px;font-size:0.75rem;font-weight:500}
    .badge-success{background:#28a745;color:#fff}
    .badge-warning{background:#ffc107;color:#000}
    .badge-secondary{background:#6c757d;color:#fff}
    .badge-primary{background:#007bff;color:#fff}
    .badge-info{background:#17a2b8;color:#fff}
    .text-truncate{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sort-controls{background:rgba(212,175,55,0.1);border:1px solid rgba(212,175,55,0.3);border-radius:8px;padding:15px;margin-bottom:20px}
    .sort-btn{background:linear-gradient(135deg,rgba(212,175,55,0.2),rgba(212,175,55,0.1));border:1px solid rgba(212,175,55,0.4);color:var(--luxury-gold);padding:6px 12px;border-radius:6px;margin:0 3px;cursor:pointer;transition:all 0.3s;font-size:0.85rem}
    .sort-btn:hover,.sort-btn.active{background:linear-gradient(135deg,var(--luxury-gold),#f4d03f);color:var(--luxury-black);transform:translateY(-1px);box-shadow:0 4px 8px rgba(212,175,55,0.3)}
    .filter-group{display:flex;align-items:center;gap:10px;margin:5px 0}
    .filter-select{background:rgba(0,0,0,0.4);border:1px solid rgba(212,175,55,0.3);color:var(--text-luxury-light);padding:5px 10px;border-radius:4px}
    .btn-outline-info{border:1px solid var(--luxury-gold);color:var(--luxury-gold);background:transparent}
    .btn-outline-info:hover{background:var(--luxury-gold);color:var(--luxury-black);border-color:var(--luxury-gold)}
    .dataTables_wrapper .dataTables_length select, .dataTables_wrapper .dataTables_filter input{background:rgba(0,0,0,0.4);border:1px solid rgba(212,175,55,0.3);color:var(--text-luxury-light);padding:4px 8px;border-radius:4px}
    .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate{color:var(--text-luxury-light)}
    .page-link{background:rgba(212,175,55,0.1);border-color:rgba(212,175,55,0.3);color:var(--luxury-gold)}
    .page-link:hover{background:var(--luxury-gold);border-color:var(--luxury-gold);color:var(--luxury-black)}
    .status-badge[data-status="Confirmed"] { background-color: #28a745 !important; color: #fff !important; }
    .status-badge[data-status="Cancelled"], .status-badge[data-status="Returned"] { background-color: #6c757d !important; color: #fff !important; }
    .status-badge[data-status="Pending Payment"], .status-badge[data-status="Payment Pending"] { background-color: #ffc107 !important; color: #000 !important; }
    .status-badge:not([data-status="Confirmed"]):not([data-status="Cancelled"]):not([data-status="Returned"]):not([data-status="Pending Payment"]):not([data-status="Payment Pending"]) { background-color: #007bff !important; color: #fff !important; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-luxury fixed-top">
    <div class="container">
      <a class="navbar-brand-luxury" href="/fleet-manager/dashboard"><i class="fas fa-crown mr-2"></i>VeloRent Fleet Manager</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item"><a class="nav-link-luxury" href="/fleet-manager/dashboard">Main Dashboard</a></li>
          <li class="nav-item"><a class="nav-link-luxury" href="/fleet-manager/packages">Packages</a></li>
          <li class="nav-item"><a class="nav-link-luxury" href="/fleet-manager/vehicle-usage-history">Usage History</a></li>
          <li class="nav-item"><a class="nav-link-luxury" href="/fleet-manager/maintenance">Maintenance</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="page-title mb-0"><i class="fas fa-clipboard-list mr-2"></i>All Bookings</h2>
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-info btn-sm mr-3" onclick="window.location.reload()" title="Refresh Data">
          <i class="fas fa-sync-alt mr-1"></i>Refresh
        </button>
  <span class="badge badge-info mr-3" th:text="'Total: ' + ${(bookingsCount != null) ? bookingsCount : (bookings != null ? bookings.size() : 0)}">Total: 0</span>
        <small class="text-muted mr-3" id="lastUpdate"></small>
        <div id="message" class="text-warning"></div>
      </div>
    </div>

  <!-- Quick Stats -->
  <div class="row mb-3">
      <div class="col-md-3">
        <div class="card" style="background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border: 2px solid var(--luxury-gold); border-radius: 8px;">
          <div class="card-body text-center" style="padding: 20px;">
            <div style="border-bottom: 2px solid var(--luxury-gold); padding-bottom: 10px; margin-bottom: 15px;">
              <i class="fas fa-check-circle" style="color: var(--luxury-gold); margin-right: 8px;"></i>
              <span style="color: var(--luxury-gold); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">CONFIRMED</span>
            </div>
            <h1 id="confirmedCount" th:text="${confirmedCount}" style="color: var(--luxury-gold); font-weight: 900; font-size: 3.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">0</h1>
            <small style="color: var(--text-luxury-light); font-size: 0.85rem; margin-top: 5px;">BOOKINGS</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card" style="background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border: 2px solid var(--luxury-gold); border-radius: 8px;">
          <div class="card-body text-center" style="padding: 20px;">
            <div style="border-bottom: 2px solid var(--luxury-gold); padding-bottom: 10px; margin-bottom: 15px;">
              <i class="fas fa-clock" style="color: var(--luxury-gold); margin-right: 8px;"></i>
              <span style="color: var(--luxury-gold); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">PENDING PAYMENT</span>
            </div>
            <h1 id="pendingCount" th:text="${pendingCount}" style="color: var(--luxury-gold); font-weight: 900; font-size: 3.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">0</h1>
            <small style="color: var(--text-luxury-light); font-size: 0.85rem; margin-top: 5px;">AWAITING PAYMENT</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card" style="background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border: 2px solid var(--luxury-gold); border-radius: 8px;">
          <div class="card-body text-center" style="padding: 20px;">
            <div style="border-bottom: 2px solid var(--luxury-gold); padding-bottom: 10px; margin-bottom: 15px;">
              <i class="fas fa-undo" style="color: var(--luxury-gold); margin-right: 8px;"></i>
              <span style="color: var(--luxury-gold); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">RETURNED</span>
            </div>
            <h1 id="returnedCount" th:text="${returnedCount}" style="color: var(--luxury-gold); font-weight: 900; font-size: 3.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">0</h1>
            <small style="color: var(--text-luxury-light); font-size: 0.85rem; margin-top: 5px;">COMPLETED</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card" style="background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border: 2px solid var(--luxury-gold); border-radius: 8px;">
          <div class="card-body text-center" style="padding: 20px;">
            <div style="border-bottom: 2px solid var(--luxury-gold); padding-bottom: 10px; margin-bottom: 15px;">
              <i class="fas fa-times-circle" style="color: var(--luxury-gold); margin-right: 8px;"></i>
              <span style="color: var(--luxury-gold); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">CANCELLED</span>
            </div>
            <h1 id="cancelledCount" th:text="${cancelledCount}" style="color: var(--luxury-gold); font-weight: 900; font-size: 3.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">0</h1>
            <small style="color: var(--text-luxury-light); font-size: 0.85rem; margin-top: 5px;">CANCELLED</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Sorting and Filtering Controls -->
    <div class="sort-controls">
      <div class="row">
        <div class="col-md-8">
          <div class="filter-group">
            <label class="text-warning font-weight-bold mr-2"><i class="fas fa-sort mr-1"></i>Quick Sort:</label>
            <button class="sort-btn" data-sort="recent">📅 Recent First</button>
            <button class="sort-btn" data-sort="oldest">📅 Oldest First</button>
            <button class="sort-btn" data-sort="amount-high">💰 Highest Amount</button>
            <button class="sort-btn" data-sort="amount-low">💰 Lowest Amount</button>
            <button class="sort-btn" data-sort="customer">👤 Customer A-Z</button>
          </div>
        </div>
        <div class="col-md-4">
          <div class="filter-group">
            <label class="text-warning font-weight-bold mr-2"><i class="fas fa-filter mr-1"></i>Filter:</label>
            <select class="filter-select" id="statusFilter">
              <option value="">All Status</option>
              <option value="Confirmed">Confirmed</option>
              <option value="Pending Payment">Pending Payment</option>
              <option value="Returned">Returned</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Flash Messages -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fas fa-check-circle mr-2"></i>
      <span th:text="${successMessage}">Success message</span>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      <span th:text="${errorMessage}">Error message</span>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div th:if="${error}" class="alert alert-warning alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      <span th:text="${error}">Error message</span>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="lux-card p-3">
      <div th:if="${bookings != null && !bookings.empty}" class="table-responsive">
        <table id="bookingsTable" class="table table-dark table-striped table-hover w-100">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Status</th>
              <th>Customer</th>
              <th>Item</th>
              <th>Start</th>
              <th>End</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="booking : ${bookings}" th:attr="data-booking-id=${booking.bookingId}">
              <td th:text="${booking.bookingId}" th:attr="data-order=${booking.bookingId}">#1</td>
              <td>
                <span class="badge badge-info" th:text="${booking.bookingType}">VEHICLE</span>
              </td>
              <td>
                <span class="badge status-badge" th:text="${booking.bookingStatus}" th:attr="data-status=${booking.bookingStatus}">Status</span>
              </td>
              <td>
                <div><strong th:text="${booking.customerName != null ? booking.customerName : 'N/A'}">John Doe</strong></div>
                <div class="small text-muted" th:text="${booking.customerEmail != null ? booking.customerEmail : ''}">john@example.com</div>
              </td>
              <td>
        <div class="text-truncate" style="max-width:200px">
      <span th:if="${booking.bookingType == 'VEHICLE'}"
        th:text="${(booking.vehicleMake != null ? booking.vehicleMake : '') + ' ' + (booking.vehicleModel != null ? booking.vehicleModel : '')}">Vehicle Info</span>
      <span th:if="${booking.bookingType == 'PACKAGE'}"
        th:text="${booking.packageName}">Package Info</span>
        </div>
              </td>
        <td th:text="${#temporals.format(booking.startDate, 'yyyy-MM-dd HH:mm')}"
          th:attr="data-order=${#temporals.format(booking.startDate, 'yyyyMMddHHmmss')}">2024-01-01 10:00</td>
        <td th:text="${#temporals.format(booking.endDate, 'yyyy-MM-dd HH:mm')}"
          th:attr="data-order=${#temporals.format(booking.endDate, 'yyyyMMddHHmmss')}">2024-01-03 10:00</td>
              <td th:attr="data-order=${booking.totalCost != null ? booking.totalCost : 0}">
                <span class="text-warning font-weight-bold" 
                      th:text="'Rs. ' + ${booking.totalCost}">Rs. 15,000.00</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div th:if="${bookings == null || bookings.empty}" class="text-center py-5">
        <div class="mb-3">
          <i class="fas fa-clipboard-list fa-3x text-muted"></i>
        </div>
        <h4 class="text-muted">No Bookings Found</h4>
        <p class="text-muted">There are no bookings in the system yet.</p>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content" style="background:linear-gradient(145deg,#2d2d2d,#3a3a3a);border:2px solid var(--luxury-gold)">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-info-circle mr-2"></i>Booking Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body" id="viewBody"></div>
        <div class="modal-footer"><button class="btn btn-secondary" data-dismiss="modal">Close</button></div>
      </div>
    </div>
  </div>

  <script src="/js/jQuery/jquery.min.js"></script>
  <script src="/css/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script th:inline="javascript">
    let originalRows = [];
    let currentFilter = '';

    function recomputeStats() {
      let confirmed = 0, pending = 0, returned = 0, cancelled = 0;
      const visibleRows = document.querySelectorAll('#bookingsTable tbody tr:not([style*="display: none"])');
      const totalAll = document.querySelectorAll('#bookingsTable tbody tr').length;
      const totalShown = visibleRows.length;
      
      visibleRows.forEach(row => {
        const statusBadge = row.querySelector('.status-badge');
        if (statusBadge) {
          const text = statusBadge.textContent.trim();
          switch(text) {
            case 'Confirmed': confirmed++; break;
            case 'Pending Payment':
            case 'Payment Pending': pending++; break;
            case 'Returned': returned++; break;
            case 'Cancelled': cancelled++; break;
          }
        }
      });
      
      const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
      set('confirmedCount', confirmed);
      set('pendingCount', pending);
      set('returnedCount', returned);
      set('cancelledCount', cancelled);
      
      // Update the total badge
      const totalBadge = document.querySelector('.badge-info.mr-3');
      if (totalBadge) {
        totalBadge.textContent = totalShown !== totalAll ? `Total: ${totalAll} | Shown: ${totalShown}` : `Total: ${totalAll}`;
      }
    }

    function initializeBookingsTable() {
      // Store original row order
      const tbody = document.querySelector('#bookingsTable tbody');
      if (tbody) {
        originalRows = Array.from(tbody.querySelectorAll('tr'));
      }

      // Wire up sorting controls
      document.querySelectorAll('.sort-btn').forEach(button => {
        button.addEventListener('click', function() {
          const sortType = this.getAttribute('data-sort');
          applySorting(sortType);
        });
      });
      
      // Wire up status filter
      document.getElementById('statusFilter').addEventListener('change', applyStatusFilter);

      // Add search functionality
      addSearchFunctionality();

      // Auto-dismiss alerts after 5 seconds
      setTimeout(function() { $('.alert').fadeOut(); }, 5000);

      // Visual feedback for sort buttons
      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-2px)'; });
        btn.addEventListener('mouseleave', function() { if (!this.classList.contains('active')) this.style.transform = 'translateY(0)'; });
      });

      // Set last update timestamp
      const lastUpdateElement = document.getElementById('lastUpdate');
      if (lastUpdateElement) lastUpdateElement.textContent = '📅 Updated: ' + new Date().toLocaleString();

      // Set default sort to recent first
      applySorting('recent');
      recomputeStats();
    }

    // Sorting and filtering helpers
    function applySorting(sortType) {
      if (!originalRows.length) return;
      
      // Remove active class from all buttons
      document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
      
      // Add active class to current button
      const activeBtn = document.querySelector(`[data-sort="${sortType}"]`);
      if (activeBtn) activeBtn.classList.add('active');
      
      // Create a copy of rows to sort
      const rowsToSort = [...originalRows];
      
      // Sort based on type
      rowsToSort.sort((a, b) => {
        switch(sortType) {
          case 'recent':
            const aId = parseInt(a.querySelector('td:first-child').getAttribute('data-order') || '0');
            const bId = parseInt(b.querySelector('td:first-child').getAttribute('data-order') || '0');
            return bId - aId; // Descending
            
          case 'oldest':
            const aIdOld = parseInt(a.querySelector('td:first-child').getAttribute('data-order') || '0');
            const bIdOld = parseInt(b.querySelector('td:first-child').getAttribute('data-order') || '0');
            return aIdOld - bIdOld; // Ascending
            
          case 'amount-high':
            const aCost = parseFloat(a.querySelector('td:nth-child(8)').getAttribute('data-order') || '0');
            const bCost = parseFloat(b.querySelector('td:nth-child(8)').getAttribute('data-order') || '0');
            return bCost - aCost; // Descending
            
          case 'amount-low':
            const aCostLow = parseFloat(a.querySelector('td:nth-child(8)').getAttribute('data-order') || '0');
            const bCostLow = parseFloat(b.querySelector('td:nth-child(8)').getAttribute('data-order') || '0');
            return aCostLow - bCostLow; // Ascending
            
          case 'customer':
            const aName = (a.querySelector('td:nth-child(4) strong')?.textContent || '').toLowerCase();
            const bName = (b.querySelector('td:nth-child(4) strong')?.textContent || '').toLowerCase();
            return aName.localeCompare(bName);
            
          default:
            return 0;
        }
      });
      
      // Update table with sorted rows
      const tbody = document.querySelector('#bookingsTable tbody');
      tbody.innerHTML = '';
      rowsToSort.forEach(row => tbody.appendChild(row));
      
      // Reapply current filter if any
      if (currentFilter) {
        applyStatusFilter();
      } else {
        recomputeStats();
      }
    }
    
    function applyStatusFilter() {
      const statusSelect = document.getElementById('statusFilter');
      const filterValue = statusSelect.value;
      currentFilter = filterValue;
      
      const rows = document.querySelectorAll('#bookingsTable tbody tr');
      rows.forEach(row => {
        const statusBadge = row.querySelector('.status-badge');
        const status = statusBadge ? statusBadge.textContent.trim() : '';
        
        if (!filterValue || status === filterValue) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
      
      recomputeStats();
    }
    
    function addSearchFunctionality() {
      // Add search input if it doesn't exist
      const sortControls = document.querySelector('.sort-controls .row');
      if (sortControls && !document.getElementById('searchInput')) {
        const searchHTML = `
          <div class="col-md-12 mt-2">
            <div class="filter-group">
              <label class="text-warning font-weight-bold mr-2"><i class="fas fa-search mr-1"></i>Search:</label>
              <input type="text" id="searchInput" class="form-control" style="width: 300px; background: rgba(0,0,0,0.4); border: 1px solid rgba(212,175,55,0.3); color: var(--text-luxury-light);" placeholder="Search bookings...">
            </div>
          </div>
        `;
        sortControls.insertAdjacentHTML('beforeend', searchHTML);
        
        // Add search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll('#bookingsTable tbody tr');
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
          
          recomputeStats();
        });
      }
    }

    document.addEventListener('DOMContentLoaded', initializeBookingsTable);
  </script>
</body>
</html>
