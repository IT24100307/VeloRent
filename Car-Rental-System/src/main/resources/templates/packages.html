<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Packages | VeloRent - Luxury Car Rental</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/css/fontawesome/css/all.min.css" />
    <!-- Luxury Theme CSS -->
    <link rel="stylesheet" href="/css/luxury-theme.css" />
    <style>
      body { padding-top: 80px; }
      .packages-wrapper { overflow-x: hidden; }
      .packages-container { min-height: 100vh; background: var(--gradient-luxury); }
      .navbar-luxury { background: linear-gradient(135deg, var(--luxury-black), var(--luxury-charcoal), var(--luxury-black)) !important; border-bottom: 2px solid var(--luxury-gold); box-shadow: 0 4px 20px rgba(0,0,0,.3); padding: 1rem 0; }
      .navbar-brand-luxury { font-size: 1.8rem; font-weight: 700; color: var(--luxury-gold) !important; text-decoration: none; display:flex; align-items:center; }
      .nav-link-luxury { color: var(--text-luxury-light) !important; font-weight: 600; padding: 12px 20px; margin: 0 5px; border-radius: var(--radius-luxury-small); border: 1px solid transparent; }
      .nav-link-luxury:hover { background: rgba(212,175,55,0.12); color: var(--luxury-gold) !important; border-color: var(--luxury-gold); }
      .btn-luxury { background: var(--gradient-gold); color: var(--luxury-black); border: none; padding: 10px 20px; border-radius: var(--radius-luxury-small); font-weight: 600; }
      /* Luxury-styled Details buttons */
      .btn-details {
        background: transparent;
        color: var(--luxury-gold);
        border: 2px solid var(--luxury-gold);
        border-radius: var(--radius-luxury-small);
        padding: 10px 18px;
        font-weight: 700;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
        transition: transform .2s ease, box-shadow .2s ease, background .2s ease, color .2s ease, border-color .2s ease;
      }
      .btn-details::before {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent);
        transition: left .5s ease;
      }
      .btn-details:hover::before { left: 100%; }
      .btn-details:hover {
        background: var(--gradient-gold);
        color: var(--luxury-black);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(212,175,55,.35);
        border-color: transparent;
        text-decoration: none;
      }
      .btn-details:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(212,175,55,.25); }
      .btn-details-sm { padding: 6px 12px; font-weight: 600; border-width: 2px; }
      .packages-header { text-align:center; margin-bottom: 50px; padding: 40px 0; }
      .packages-title { color: var(--luxury-gold); font-size: 3rem; font-weight: 800; }
      .packages-subtitle { color: var(--text-luxury-light); max-width: 680px; margin: 0 auto; }
  .package-card { background: linear-gradient(145deg, var(--luxury-dark), var(--luxury-charcoal)); border: 2px solid rgba(212,175,55,.3); border-radius: var(--radius-luxury); overflow: hidden; margin-bottom: 28px; }
  .package-image { width: 100%; height: 180px; object-fit: cover; border-bottom: 1px solid rgba(212,175,55,.2); display:block; }
  .package-body { padding: 24px; }
      .package-title { color: var(--luxury-gold); font-size: 1.6rem; font-weight: 700; }
      .package-price { color: var(--text-luxury-light); font-size: 1.8rem; font-weight: 800; }
      .package-duration { color: var(--luxury-gold); font-weight: 600; }
      .package-description { color: var(--text-luxury-light); }
      .package-status { display:inline-block; padding:6px 12px; border-radius: 8px; font-weight: 600; }
      .status-activated { background: linear-gradient(135deg, #10b981, #059669); color:#fff; }
      .status-partially-reserved { background: linear-gradient(135deg, #f59e0b, #d97706); color:#fff; }
      .no-packages { text-align:center; padding:60px 20px; background: linear-gradient(145deg, var(--luxury-dark), var(--luxury-charcoal)); border: 2px solid rgba(212,175,55,.3); border-radius: var(--radius-luxury); margin: 40px 0; }
      
      /* Modal Enhancements */
      .modal-backdrop { 
        background-color: rgba(0,0,0,0.8) !important; 
        z-index: 1040 !important;
      }
      .modal { 
        z-index: 1050 !important; 
      }
      .modal-dialog { 
        z-index: 1055 !important;
        margin: 30px auto !important;
      }
      .modal.fade .modal-dialog { 
        transform: scale(0.8); 
        transition: transform 0.3s ease-out; 
      }
      .modal.show .modal-dialog { 
        transform: scale(1); 
      }
      
      /* Ensure modal is visible */
      .modal.show {
        display: block !important;
      }
      
      /* Custom scrollbar for modal content */
      .modal-body::-webkit-scrollbar { width: 8px; }
      .modal-body::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 4px; }
      .modal-body::-webkit-scrollbar-thumb { background: var(--luxury-gold); border-radius: 4px; }
      .modal-body::-webkit-scrollbar-thumb:hover { background: #e6c068; }
    </style>
  </head>

  <body class="packages-wrapper">
    <nav class="navbar navbar-expand-lg navbar-luxury fixed-top">
      <div class="container">
        <a class="navbar-brand-luxury" href="/dashboard"><i class="fas fa-crown mr-2"></i>VeloRent</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item"><a class="nav-link-luxury" href="/dashboard">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link-luxury" href="/packages"><i class="fas fa-box mr-1"></i>Packages</a></li>
            <li class="nav-item"><a class="nav-link-luxury" href="/feedback">About Us</a></li>
            <li class="nav-item"><a class="nav-link-luxury" href="/security-settings">Security</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="packages-container">
      <div class="container py-5">
        <div class="packages-header">
          <h1 class="packages-title"><i class="fas fa-gem mr-3"></i>Premium Packages</h1>
          <p class="packages-subtitle">Discover our exclusive luxury car rental packages designed for the ultimate driving experience. Each package offers carefully selected vehicles and premium services.</p>
        </div>

        <div id="errorBox" class="alert alert-danger d-none"></div>

  <div id="packagesGrid" class="row"></div>

        <div id="noPackages" class="no-packages d-none">
          <div class="no-packages-icon"><i class="fas fa-box-open"></i></div>
          <h3 class="no-packages-title">No Packages Available</h3>
          <p class="no-packages-text">We're currently updating our package offerings. Please check back soon for our latest luxury car rental packages.</p>
        </div>
      </div>
    </div>

  <!-- Package Details Modal -->
    <div class="modal fade" id="packageDetailsModal" tabindex="-1" role="dialog" aria-labelledby="packageDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="background: linear-gradient(145deg, #2d2d2d, #3a3a3a); border: 2px solid var(--luxury-gold); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
          <div class="modal-header" style="border-bottom: 2px solid var(--luxury-gold); background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border-radius: 13px 13px 0 0; padding: 20px 30px;">
            <h5 class="modal-title" id="packageDetailsModalLabel" style="color: var(--luxury-gold); font-size: 1.5rem; font-weight: 700;">
              <i class="fas fa-gem mr-2"></i><span id="modalPackageTitle">Package Details</span>
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: var(--luxury-gold); font-size: 2rem; opacity: 1; background: none; border: none;">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="packageDetailsContent" style="color: var(--text-luxury-light); padding: 30px; background: linear-gradient(145deg, #2d2d2d, #3a3a3a); max-height: 60vh; overflow-y: auto;">
            <!-- Package details will be loaded here -->
            <div style="text-align: center; padding: 20px;">
              <i class="fas fa-spinner fa-spin" style="color: var(--luxury-gold); font-size: 2rem;"></i>
              <p style="margin-top: 10px;">Loading package details...</p>
            </div>
          </div>
          <div class="modal-footer" style="border-top: 2px solid var(--luxury-gold); background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border-radius: 0 0 13px 13px; padding: 20px 30px; justify-content: space-between;">
            <button type="button" class="btn" data-dismiss="modal" style="background: transparent; border: 2px solid #666; color: #ccc; padding: 10px 25px; border-radius: 8px; font-weight: 600;">CLOSE</button>
            <button type="button" class="btn" id="rentFromModal" style="background: linear-gradient(135deg, var(--luxury-gold), #e6c068); color: #000; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 700;">
              BOOK NOW
            </button>
          </div>
        </div>
      </div>
    </div>

  <!-- Rent Package Modal -->
    <div class="modal fade" id="rentPackageModal" tabindex="-1" role="dialog" aria-labelledby="rentPackageModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content" style="background: linear-gradient(145deg, #2d2d2d, #3a3a3a); border: 2px solid var(--luxury-gold); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
          <div class="modal-header" style="border-bottom: 2px solid var(--luxury-gold); background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border-radius: 13px 13px 0 0; padding: 20px 30px; text-align: center;">
            <h5 class="modal-title" id="rentPackageModalLabel" style="color: var(--luxury-gold); font-size: 1.5rem; font-weight: 700; width: 100%; margin: 0;">
              <i class="fas fa-car mr-2"></i><span id="modalTitle">Book Package</span>
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: var(--luxury-gold); font-size: 2rem; opacity: 1; background: none; border: none; position: absolute; right: 20px; top: 20px;">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" style="color: var(--text-luxury-light); padding: 30px; background: linear-gradient(145deg, #2d2d2d, #3a3a3a);">
            
            <!-- Start Date -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="color: var(--luxury-gold); font-weight: 600; margin-bottom: 8px; display: block; font-size: 1rem;">
                Start Date
              </label>
              <input type="date" class="form-control" id="rentalStartDate" required
                     style="background: #1a1a1a; border: 2px solid rgba(212, 175, 55, 0.3); color: var(--text-luxury-light); border-radius: 8px; padding: 15px; font-size: 1rem; width: 100%;">
            </div>

            <!-- End Date -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="color: var(--luxury-gold); font-weight: 600; margin-bottom: 8px; display: block; font-size: 1rem;">
                End Date
              </label>
              <input type="date" class="form-control" id="rentalEndDate" required
                     style="background: #1a1a1a; border: 2px solid rgba(212, 175, 55, 0.3); color: var(--text-luxury-light); border-radius: 8px; padding: 15px; font-size: 1rem; width: 100%;">
            </div>

            <!-- Rental Duration -->
            <div class="form-group" style="margin-bottom: 20px;">
              <label style="color: var(--luxury-gold); font-weight: 600; margin-bottom: 8px; display: block; font-size: 1rem;">
                Rental Duration
              </label>
              <div id="rentalDuration" style="background: #1a1a1a; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 8px; padding: 15px; font-size: 1rem; color: var(--text-luxury-light);">
                0 days
              </div>
            </div>

            <!-- Cost Calculation -->
            <div style="margin-bottom: 25px;">
              <label style="color: var(--luxury-gold); font-weight: 600; margin-bottom: 15px; display: block; font-size: 1rem;">
                Cost Calculation
              </label>
              
              <div style="background: #1a1a1a; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 8px; padding: 20px;">
                <!-- Daily Rate -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(212, 175, 55, 0.2);">
                  <span style="color: var(--text-luxury-light); font-size: 1rem;">Daily Rate:</span>
                  <span id="dailyRate" style="color: var(--luxury-gold); font-weight: 600; font-size: 1rem;">Rs. 0</span>
                </div>
                
                <!-- Number of Days -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(212, 175, 55, 0.2);">
                  <span style="color: var(--text-luxury-light); font-size: 1rem;">Number of Days:</span>
                  <span id="numberOfDays" style="color: var(--luxury-gold); font-weight: 600; font-size: 1rem;">0</span>
                </div>
                
                <!-- Total Cost -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px;">
                  <span style="color: var(--luxury-gold); font-weight: 700; font-size: 1.2rem;">Total Cost:</span>
                  <span id="totalCost" style="color: var(--luxury-gold); font-weight: 700; font-size: 1.2rem;">Rs. 0.00</span>
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer" style="border-top: 2px solid var(--luxury-gold); background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border-radius: 0 0 13px 13px; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
            <button type="button" class="btn" data-dismiss="modal" style="background: #d4af37; color: #000; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 700; font-size: 1rem;">
              CANCEL
            </button>
            <button type="button" class="btn" onclick="confirmPackageBooking()" style="background: #10b981; color: #fff; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 700; font-size: 1rem;">
              CONFIRM BOOKING
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Vehicle Details Modal (Packages Page) -->
    <div class="modal fade" id="vehicleDetailsModalPkg" tabindex="-1" role="dialog" aria-labelledby="vehicleDetailsModalPkgLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="background: linear-gradient(145deg, #2d2d2d, #3a3a3a); border: 2px solid var(--luxury-gold); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
          <div class="modal-header" style="border-bottom: 2px solid var(--luxury-gold); background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border-radius: 13px 13px 0 0; padding: 20px 30px;">
            <h5 class="modal-title" id="vehicleDetailsModalPkgLabel" style="color: var(--luxury-gold); font-weight: 700;">
              <i class="fas fa-car mr-2"></i><span id="pkgVehTitle">Vehicle Details</span>
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: var(--luxury-gold);">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" style="color: var(--text-luxury-light); padding: 24px;">
            <div class="row">
              <div class="col-md-6">
                <img id="pkgVehImage" src="" alt="Vehicle" style="width: 100%; height: 260px; object-fit: cover; border-radius: 10px; border: 1px solid rgba(212,175,55,.3);">
              </div>
              <div class="col-md-6">
                <div class="mb-3"><strong class="text-muted">Brand</strong><div id="pkgVehMake" class="text-warning"></div></div>
                <div class="mb-3"><strong class="text-muted">Model</strong><div id="pkgVehModel" class="text-warning"></div></div>
                <div class="mb-3"><strong class="text-muted">Year</strong><div id="pkgVehYear" class="text-warning"></div></div>
                <div class="mb-3"><strong class="text-muted">Registration</strong><div id="pkgVehReg" class="text-warning"></div></div>
                <div class="mb-3"><strong class="text-muted">Rental Rate</strong><div id="pkgVehRate" class="text-warning" style="font-size: 1.2rem; font-weight: 700;"></div></div>
                <div class="mb-3"><strong class="text-muted">Status</strong><div id="pkgVehStatus" class="text-success"></div></div>
              </div>
            </div>
          </div>
          <div class="modal-footer" style="border-top: 2px solid var(--luxury-gold); background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border-radius: 0 0 13px 13px; padding: 16px 24px;">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/js/jquery/jquery.min.js"></script>
    <script src="/css/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script>
      let currentPackageId = null;
      let currentPackageName = null;

      // Authentication utility function
      function isUserLoggedIn() {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        console.log('Checking authentication - token found:', !!token);
        
        if (!token) {
          console.log('No authentication token found');
          return false;
        }
        
        try {
          // Basic token validation (check if it's not expired if JWT)
          const tokenParts = token.split('.');
          if (tokenParts.length === 3) {
            // It's a JWT token, check expiration
            const payload = JSON.parse(atob(tokenParts[1]));
            const currentTime = Math.floor(Date.now() / 1000);
            if (payload.exp && payload.exp < currentTime) {
              console.log('Token has expired');
              localStorage.removeItem('token');
              sessionStorage.removeItem('token');
              return false;
            }
          }
          return true;
        } catch (error) {
          console.error('Token validation error:', error);
          return !!token; // Fall back to just checking if token exists
        }
      }

      // Test function to debug modal
      function testModal() {
        console.log('Testing modal...');
        const modal = document.getElementById('packageDetailsModal');
        console.log('Modal element:', modal);
        modal.style.display = 'block';
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        
        if (!document.querySelector('.modal-backdrop')) {
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          backdrop.style.zIndex = '1040';
          document.body.appendChild(backdrop);
        }
      }

      // Test function to debug rental modal
      function testRentalModal() {
        console.log('Testing rental modal...');
        const modal = document.getElementById('rentPackageModal');
        console.log('Rental modal element:', modal);
        modal.style.display = 'block';
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        
        if (!document.querySelector('.modal-backdrop')) {
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          backdrop.style.zIndex = '1040';
          document.body.appendChild(backdrop);
        }
      }

      // Make test functions available globally for debugging
      window.testModal = testModal;
      window.testRentalModal = testRentalModal;

      function currencyFormat(n) {
        try { return new Intl.NumberFormat('en-LK', { style: 'currency', currency: 'LKR', maximumFractionDigits: 0 }).format(n); } catch { return `Rs. ${n}`; }
      }

      function showError(msg) {
        const el = document.getElementById('errorBox');
        el.textContent = msg;
        el.classList.remove('d-none');
      }

      function renderPackages(list) {
        const grid = document.getElementById('packagesGrid');
        grid.innerHTML = '';
        if (!list || !list.length) {
          document.getElementById('noPackages').classList.remove('d-none');
          return;
        }
        document.getElementById('noPackages').classList.add('d-none');

        list.forEach(pkg => {
          const col = document.createElement('div');
          col.className = 'col-lg-6 col-xl-4';
          const imgSrc = pkg.imageUrl || 'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1400&q=80';
          col.innerHTML = `
            <div class="package-card">
              <img class="package-image" src="${imgSrc}" alt="${(pkg.packageName||'Package').replace(/"/g,'&quot;')}" onerror="this.src='https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1400&q=80'" />
              <div class="package-body">
                <div class="package-header">
                  <h3 class="package-title">${pkg.packageName || 'Package'}</h3>
                  <div class="package-price">${currencyFormat(pkg.price || 0)}</div>
                  <div class="package-duration"><i class="fas fa-calendar-alt mr-2"></i>${pkg.duration || 0} Days</div>
                  <span class="package-status ${pkg.status === 'Activated' ? 'status-activated' : 'status-partially-reserved'}">${pkg.status || 'Unknown'}</span>
                </div>
                <div class="package-content">
                  <div class="package-description">${pkg.description || 'Package description not provided.'}</div>
                </div>
                <div class="package-actions mt-3">
                  <button class="btn btn-details mr-2" onclick="viewPackageDetails(${pkg.packageId}, '${(pkg.packageName||'').replace(/'/g,"\\'").replace(/"/g,'&quot;')}')"><i class="fas fa-info-circle mr-1"></i>Details</button>
                  ${pkg.status === 'Activated'
                    ? `<button class="btn btn-sm btn-luxury" onclick="rentPackage(${pkg.packageId}, '${(pkg.packageName||'').replace(/'/g,"\\'").replace(/"/g,'&quot;')}')"><i class="fas fa-car mr-1"></i>Book Now</button>`
                    : `<span class="text-warning d-inline-block mr-2"><i class="fas fa-exclamation-circle mr-1"></i>This package is currently unavailable</span>`}
                </div>
              </div>
            </div>`;
          grid.appendChild(col);
        });
      }

      async function loadPackages() {
        try {
          const res = await fetch('/api/public/packages', { method: 'GET' });
          if (!res.ok) throw new Error('Failed to load packages');
          const data = await res.json();
          renderPackages(data);
        } catch (err) {
          showError('Unable to load packages at this time. Please try again later.');
          console.error(err);
        }
      }

      async function viewPackageDetails(packageId, packageName) {
        console.log('viewPackageDetails called with:', packageId, packageName);
        currentPackageId = packageId;
        currentPackageName = packageName;
        let availability = null;
        try {
          const res = await fetch(`/api/public/packages/${packageId}/availability`);
          if (res.ok) availability = await res.json();
        } catch {}

        // Try to find the package in the current grid for richer details (like vehicles)
        let pkgData = null;
        try {
          const res = await fetch('/api/public/packages');
          if (res.ok) {
            const arr = await res.json();
            pkgData = (Array.isArray(arr) ? arr : []).find(p => p.packageId === packageId);
          }
        } catch {}

        const vehicleList = (pkgData?.vehicles || []).map(v => `
          <li class="media" style="margin-bottom:12px;">
            <img src="${v.imageUrl || 'https://images.unsplash.com/photo-1549921296-3a6b3d87f6c6?auto=format&fit=crop&w=300&q=60'}" class="mr-3" style="width:72px;height:48px;object-fit:cover;border-radius:6px;border:1px solid rgba(212,175,55,.2)" onerror="this.src='https://images.unsplash.com/photo-1549921296-3a6b3d87f6c6?auto=format&fit=crop&w=300&q=60'"/>
            <div class="media-body">
              <div><strong>${v.make || ''} ${v.model || ''}</strong> â€¢ ${v.year || ''}</div>
              <small>Status: ${v.status || 'Unknown'}</small>
            </div>
          </li>`).join('') || '<li>No vehicles listed for this package yet.</li>';

        const availabilityHtml = availability ? `<div class="alert ${availability.available ? 'alert-success' : 'alert-warning'}" style="padding:8px 12px;">
          <i class="fas ${availability.available ? 'fa-check-circle' : 'fa-clock'} mr-1"></i>
          ${availability.message || ''}
        </div>` : '';

        const content = `
          ${availabilityHtml}
          <div style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 8px; border-left: 4px solid var(--luxury-gold);">
              <div>
                <div style="color: var(--luxury-gold); font-weight: 700; font-size: 1.1rem;">Price: ${pkgData ? currencyFormat(pkgData.price) : 'N/A'}</div>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 8px; border-left: 4px solid var(--luxury-gold);">
              <div>
                <div style="color: var(--luxury-gold); font-weight: 700; font-size: 1.1rem;">Duration: ${pkgData ? pkgData.duration : 'N/A'} days</div>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 8px; border-left: 4px solid var(--luxury-gold);">
              <div>
                <div style="color: var(--luxury-gold); font-weight: 700; font-size: 1.1rem;">Status: <span style="color: ${pkgData?.status === 'Activated' ? '#10b981' : '#f59e0b'};">${pkgData?.status || 'Unknown'}</span></div>
              </div>
            </div>
          </div>
          <div style="margin-bottom: 20px;">
            <h6 style="color: var(--luxury-gold); margin-bottom: 15px; font-size: 1.2rem; font-weight: 700;"><i class="fas fa-car mr-2"></i>Included Vehicles:</h6>
            <div style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 8px; padding: 20px;">
              ${(pkgData?.vehicles || []).map(v => {
                const hasDiscount = !!v.discountedRatePerDay;
                const baseRate = v.rentalRatePerDay || v.rate || 0;
                const displayRate = hasDiscount ? v.discountedRatePerDay : baseRate;
                const rateHtml = hasDiscount
                  ? `<span style="text-decoration: line-through; opacity:.7;">${currencyFormat(baseRate)}/day</span> <span style="color:#e74c3c;font-weight:700;">${currencyFormat(displayRate)}/day</span>`
                  : `${currencyFormat(displayRate)}/day`;
                const statusOk = (v.status || '').toUpperCase() === 'AVAILABLE';
                return `
                <div style="display: flex; align-items: center; margin-bottom: 15px; padding: 12px; background: rgba(212,175,55,0.1); border-radius: 6px; border: 1px solid rgba(212,175,55,0.2);">
                  <img src="${v.imageUrl || 'https://images.unsplash.com/photo-1549921296-3a6b3d87f6c6?auto=format&fit=crop&w=300&q=60'}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 15px; border: 1px solid rgba(212,175,55,0.3);" onerror="this.src='https://images.unsplash.com/photo-1549921296-3a6b3d87f6c6?auto=format&fit=crop&w=300&q=60'"/>
                  <div style="flex: 1;">
                    <div style="color: var(--luxury-gold); font-weight: 600; font-size: 1rem;">${v.make || ''} ${v.model || ''}</div>
                    <div style="color: #ccc; font-size: 0.9rem;">Year: ${v.year || 'N/A'} | Rate: ${rateHtml}</div>
                    <div style="color: ${statusOk ? '#10b981' : '#f59e0b'}; font-size: 0.85rem; font-weight: 600;">Status: ${v.status || 'Unknown'}</div>
                  </div>
                  <button class="btn btn-details btn-details-sm" data-view-vehicle-id="${v.vehicleId}">View Details</button>
                </div>`;
              }).join('') || '<div style="text-align: center; color: #999; padding: 20px;">No vehicles listed for this package yet.</div>'}
            </div>
          </div>`;
        document.getElementById('packageDetailsContent').innerHTML = content;
        document.getElementById('modalPackageTitle').textContent = packageName;
        
        // Set up the Book Now button click handler and availability control
        const bookNowBtn = document.getElementById('rentFromModal');
        if (bookNowBtn) {
          if (availability && availability.available === false) {
            bookNowBtn.disabled = true;
            bookNowBtn.textContent = 'UNAVAILABLE';
            bookNowBtn.style.opacity = '0.7';
            bookNowBtn.style.cursor = 'not-allowed';
          } else {
            bookNowBtn.disabled = false;
            bookNowBtn.textContent = 'BOOK NOW';
            bookNowBtn.onclick = function() {
              console.log('Book Now button clicked in modal');
              // Close the details modal first
              if (typeof $ !== 'undefined') {
                $('#packageDetailsModal').modal('hide');
                // Wait for modal to close, then open rental modal
                setTimeout(() => {
                  console.log('Opening rental modal after details modal closed');
                  rentPackage(packageId, packageName);
                }, 400);
              } else {
                // Fallback if jQuery is not available
                const detailsModal = document.getElementById('packageDetailsModal');
                detailsModal.style.display = 'none';
                detailsModal.classList.remove('show');
                // Wait a bit then open rental modal
                setTimeout(() => {
                  rentPackage(packageId, packageName);
                }, 200);
              }
            };
          }
        }
        
        // Show the modal
        console.log('Attempting to show modal');
        const modal = document.getElementById('packageDetailsModal');
        console.log('Modal element found:', modal);
        
        if (typeof $ !== 'undefined') {
          console.log('Using jQuery to show modal');
          $('#packageDetailsModal').modal({
            backdrop: 'static',
            keyboard: false,
            show: true
          });
          
          // Force modal to be visible
          setTimeout(() => {
            $('#packageDetailsModal').addClass('show');
            $('body').addClass('modal-open');
          }, 100);
        } else {
          // Fallback if jQuery is not available
          console.log('Using fallback modal display');
          modal.style.display = 'block';
          modal.classList.add('show');
          document.body.classList.add('modal-open');
          
          // Create backdrop if it doesn't exist
          if (!document.querySelector('.modal-backdrop')) {
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
          }
        }

        // Wire up vehicle "View Details" buttons to open vehicle modal
        try {
          const allVehicles = (pkgData && Array.isArray(pkgData.vehicles)) ? pkgData.vehicles : [];
          document.querySelectorAll('[data-view-vehicle-id]').forEach(btn => {
            btn.addEventListener('click', () => {
              const vid = parseInt(btn.getAttribute('data-view-vehicle-id'));
              const v = allVehicles.find(x => x.vehicleId === vid);
              if (!v) return;
              // Populate modal
              document.getElementById('pkgVehTitle').textContent = `${v.make || ''} ${v.model || ''}`.trim() || 'Vehicle Details';
              document.getElementById('pkgVehImage').src = v.imageUrl || 'https://via.placeholder.com/400x260?text=No+Image';
              document.getElementById('pkgVehMake').textContent = v.make || 'N/A';
              document.getElementById('pkgVehModel').textContent = v.model || 'N/A';
              document.getElementById('pkgVehYear').textContent = v.year || 'N/A';
              document.getElementById('pkgVehReg').textContent = v.registrationNumber || 'N/A';
              const baseRate = v.rentalRatePerDay || v.rate || 0;
              const hasDiscount = !!v.discountedRatePerDay;
              if (hasDiscount) {
                document.getElementById('pkgVehRate').innerHTML = `<span style="text-decoration: line-through; opacity:.7;">${currencyFormat(baseRate)}/day</span><br><span style="color:#e74c3c;font-weight:700;">${currencyFormat(v.discountedRatePerDay)}/day</span>`;
              } else {
                document.getElementById('pkgVehRate').textContent = `${currencyFormat(baseRate)}/day`;
              }
              document.getElementById('pkgVehStatus').textContent = v.status || 'Unknown';
              // Show modal
              if (typeof $ !== 'undefined') {
                $('#vehicleDetailsModalPkg').modal('show');
              } else {
                const m = document.getElementById('vehicleDetailsModalPkg');
                m.style.display = 'block';
                m.classList.add('show');
                document.body.classList.add('modal-open');
                if (!document.querySelector('.modal-backdrop')) {
                  const backdrop = document.createElement('div');
                  backdrop.className = 'modal-backdrop fade show';
                  document.body.appendChild(backdrop);
                }
              }
            });
          });
        } catch (e) {
          console.warn('Failed to wire vehicle detail buttons', e);
        }
      }

      function rentPackage(packageId, packageName) {
        console.log('rentPackage called with:', packageId, packageName);
        currentPackageId = packageId;
        currentPackageName = packageName;
        
        // Find package data for price calculation
        let currentPackageData = null;
        
        // Update modal title
        document.getElementById('modalTitle').textContent = `Book ${packageName}`;
        
        // Set date constraints
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.getElementById('rentalStartDate');
        const endDateInput = document.getElementById('rentalEndDate');
        
        startDateInput.min = today;
        startDateInput.value = today;
        
        // Set default end date (start date + 1 day minimum)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        endDateInput.min = tomorrow.toISOString().split('T')[0];
        endDateInput.value = tomorrow.toISOString().split('T')[0];
        
        // Try to get package data for price display
        fetch('/api/public/packages')
          .then(res => res.json())
          .then(data => {
            currentPackageData = (Array.isArray(data) ? data : []).find(p => p.packageId === packageId);
            if (currentPackageData) {
              updateCostCalculation();
            }
          })
          .catch(err => console.error('Error loading package data:', err));
        
        // Add event listeners for date changes
        startDateInput.addEventListener('change', updateCostCalculation);
        endDateInput.addEventListener('change', function() {
          // Ensure end date is after start date
          const startDate = new Date(startDateInput.value);
          const endDate = new Date(this.value);
          if (endDate <= startDate) {
            const newEndDate = new Date(startDate);
            newEndDate.setDate(newEndDate.getDate() + 1);
            this.value = newEndDate.toISOString().split('T')[0];
          }
          updateCostCalculation();
        });
        
        function updateCostCalculation() {
          const startDate = startDateInput.value;
          const endDate = endDateInput.value;
          
          if (startDate && endDate && currentPackageData) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            
            // Calculate daily rate and total cost
            const basePrice = currentPackageData.price;
            const baseDays = currentPackageData.duration;
            const dailyRate = basePrice / baseDays;
            let totalCost = basePrice;
            
            if (days !== baseDays) {
              totalCost = dailyRate * days;
            }
            
            // Update display elements
            document.getElementById('rentalDuration').textContent = `${days} day${days > 1 ? 's' : ''}`;
            document.getElementById('dailyRate').textContent = currencyFormat(Math.round(dailyRate));
            document.getElementById('numberOfDays').textContent = days.toString();
            document.getElementById('totalCost').textContent = currencyFormat(Math.round(totalCost));
          } else {
            // Reset values if no valid dates
            document.getElementById('rentalDuration').textContent = '0 days';
            document.getElementById('dailyRate').textContent = 'Rs. 0';
            document.getElementById('numberOfDays').textContent = '0';
            document.getElementById('totalCost').textContent = 'Rs. 0.00';
          }
        }
        
        // Show the rental modal
        console.log('Attempting to show rental modal');
        const modal = document.getElementById('rentPackageModal');
        console.log('Rental modal element found:', modal);
        
        if (typeof $ !== 'undefined') {
          console.log('Using jQuery to show rental modal');
          $('#rentPackageModal').modal({
            backdrop: 'static',
            keyboard: false,
            show: true
          });
          
          // Force modal to be visible
          setTimeout(() => {
            $('#rentPackageModal').addClass('show');
            $('body').addClass('modal-open');
          }, 100);
        } else {
          // Fallback if jQuery is not available
          console.log('Using fallback rental modal display');
          modal.style.display = 'block';
          modal.classList.add('show');
          document.body.classList.add('modal-open');
          
          // Create backdrop if it doesn't exist
          if (!document.querySelector('.modal-backdrop')) {
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.style.zIndex = '1040';
            document.body.appendChild(backdrop);
          }
        }
      }

      // Validate booking form data for new modal layout
      function validateBookingForm() {
        const startDate = document.getElementById('rentalStartDate').value;
        const endDate = document.getElementById('rentalEndDate').value;
        
        if (!startDate) {
          alert('Please select a start date for your rental.');
          return false;
        }
        
        if (!endDate) {
          alert('Please select an end date for your rental.');
          return false;
        }
        
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (end <= start) {
          alert('End date must be after start date.');
          return false;
        }
        
        if (start < new Date().setHours(0,0,0,0)) {
          alert('Start date cannot be in the past.');
          return false;
        }
        
        return true;
      }
      
      // Main confirm booking function (packages): don't create booking before payment
      async function confirmPackageBooking() {
        console.log('Starting package booking process (no pre-booking, defer to payment)...');

        // Check if user is logged in
        if (!isUserLoggedIn()) {
          alert('Please log in to make a booking.');
          window.location.href = '/login?message=' + encodeURIComponent('Please log in to make a booking') + '&redirect=' + encodeURIComponent(window.location.href);
          return;
        }

        if (!validateBookingForm()) return;

        const confirmBtn = document.querySelector('button[onclick="confirmPackageBooking()"]');
        if (confirmBtn) {
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'Preparing...';
        }

        const startDate = document.getElementById('rentalStartDate').value;
        const endDate = document.getElementById('rentalEndDate').value;

        // Derive duration and total cost from the UI display
        const start = new Date(startDate);
        const end = new Date(endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        const totalCost = parseFloat(document.getElementById('totalCost').textContent.replace(/[^\d.]/g, '')) || 0;

        // Save intent locally so the payment page can create the booking atomically with payment
        const pending = {
          packageId: currentPackageId,
          packageName: currentPackageName,
          startDate,
          endDate,
          totalCost,
          duration: days
        };
        localStorage.setItem('pendingPackageBooking', JSON.stringify(pending));
        localStorage.setItem('selectedPackage', JSON.stringify({
          packageId: currentPackageId,
          packageName: currentPackageName,
          price: totalCost,
          totalCost: totalCost,
          duration: days
        }));

        // Close modal then redirect to payment page in package mode
        if (typeof $ !== 'undefined') {
          $('#rentPackageModal').modal('hide');
        } else {
          const modal = document.getElementById('rentPackageModal');
          if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            document.querySelector('.modal-backdrop')?.remove();
          }
        }

        console.log('Redirecting to payment with deferred booking...');
        window.location.href = `/payment?mode=package&type=package&packageId=${currentPackageId}`;
      }
      
      // Create booking without immediate payment
      async function validateAndCreateBooking() {
        if (!validateBookingForm()) return;
        
        const bookingData = {
          packageId: currentPackageId,
          startDate: document.getElementById('rentalStartDate').value + 'T10:00:00', // Add time
          endDate: document.getElementById('rentalEndDate').value + 'T18:00:00', // Add time
          specialRequests: document.getElementById('specialRequests').value || ''
        };
        
        console.log('Creating package booking:', bookingData);
        
        try {
          const response = await fetch('/api/bookings/package', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(bookingData)
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Booking created successfully! You can complete payment later from your dashboard.');
            // Close modal
            if (typeof $ !== 'undefined') {
              $('#rentPackageModal').modal('hide');
            } else {
              document.getElementById('rentPackageModal').style.display = 'none';
              document.body.classList.remove('modal-open');
              document.querySelector('.modal-backdrop')?.remove();
            }
            
            // Optionally redirect to dashboard or booking history
            // window.location.href = '/dashboard';
          } else {
            alert('Error creating booking: ' + (result.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error creating booking:', error);
          alert('Error creating booking. Please try again.');
        }
      }
      
      // Create booking and proceed to payment
      async function validateAndProceedToPayment() {
        if (!validateBookingForm()) return;
        
        const bookingData = {
          packageId: currentPackageId,
          startDate: document.getElementById('rentalStartDate').value + 'T10:00:00', // Add time
          endDate: document.getElementById('rentalEndDate').value + 'T18:00:00', // Add time
          paymentMethod: 'Card', // Default payment method
          specialRequests: document.getElementById('specialRequests').value || ''
        };
        
        console.log('Creating package booking with payment:', bookingData);
        
        try {
          const response = await fetch('/api/bookings/package/with-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(bookingData)
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Close modal first
            if (typeof $ !== 'undefined') {
              $('#rentPackageModal').modal('hide');
            } else {
              document.getElementById('rentPackageModal').style.display = 'none';
              document.body.classList.remove('modal-open');
              document.querySelector('.modal-backdrop')?.remove();
            }
            
            // Redirect to payment page with booking ID
            const bookingId = result.booking?.bookingId;
            if (bookingId) {
              window.location.href = `/payment?bookingId=${bookingId}&type=package`;
            } else {
              window.location.href = `/payment?packageId=${currentPackageId}&startDate=${bookingData.startDate}&endDate=${bookingData.endDate}&requests=${encodeURIComponent(bookingData.specialRequests)}`;
            }
          } else {
            alert('Error creating booking: ' + (result.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error creating booking with payment:', error);
          alert('Error processing booking. Please try again.');
        }
      }

      function proceedToPayment() {
        console.log('proceedToPayment called with packageId:', currentPackageId);
        const startDate = document.getElementById('rentalStartDate').value;
        const specialRequests = document.getElementById('specialRequests').value;
        if (!startDate) { 
          alert('Please select a start date for your rental.'); 
          return; 
        }
        const url = `/payment?packageId=${currentPackageId}&startDate=${startDate}&requests=${encodeURIComponent(specialRequests||'')}`;
        console.log('Redirecting to:', url);
        window.location.href = url;
      }

      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - initializing packages page');
        console.log('jQuery available:', typeof $ !== 'undefined');
        
        // Guard: if user is not logged in, redirect to login with redirect back to /packages
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          if (!token) {
            const msg = encodeURIComponent('Please log in to view packages');
            const redir = encodeURIComponent('/packages');
            window.location.replace(`/login?message=${msg}&redirect=${redir}`);
            return; // stop initializing the page
          }
        } catch (e) { console.warn('Auth guard error', e); }

        // Set up close button handlers
        const closeButtons = document.querySelectorAll('[data-dismiss="modal"]');
        closeButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            console.log('Close button clicked');
            const modal = btn.closest('.modal');
            if (modal) {
              if (typeof $ !== 'undefined') {
                $(modal).modal('hide');
              } else {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                document.querySelector('.modal-backdrop')?.remove();
              }
            }
          });
        });
        
        // Initialize page authentication status
        function initializePage() {
          console.log('Initializing page...');
          const isLoggedIn = isUserLoggedIn();
          console.log('User logged in status:', isLoggedIn);
          
          // You can add UI updates here based on login status
          // For example, show/hide certain buttons or display user info
          if (!isLoggedIn) {
            console.log('User not logged in - some features may be limited');
          }
        }
        
        // Initialize everything when page loads
        initializePage();
        loadPackages();
      });
    </script>
  </body>
</html>