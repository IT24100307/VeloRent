<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment | VeloRent - Luxury Car Rental</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/css/fontawesome/css/all.min.css" />
    <!-- Luxury Theme CSS -->
    <link rel="stylesheet" href="/css/luxury-theme.css" />
    <style>
      /* Luxury Payment Page Styling */
      body {
        background: var(--gradient-luxury) !important;
        color: var(--text-luxury-light) !important;
        line-height: 1.6;
        min-height: 100vh;
        padding-top: 20px;
        font-family: var(--font-luxury-secondary);
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
        padding-top: 20px;
      }

      /* Enhanced Navigation Styling */
      .navbar-luxury {
        background: linear-gradient(135deg, var(--luxury-black) 0%, var(--luxury-charcoal) 50%, var(--luxury-black) 100%) !important;
        border-bottom: 2px solid var(--luxury-gold);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        padding: 1rem 0;
        z-index: 1030 !important;
      }

      .navbar-brand-luxury {
        font-size: 1.6rem !important;
        font-weight: 700 !important;
        color: var(--luxury-gold) !important;
        font-family: var(--font-luxury-primary) !important;
        text-decoration: none !important;
      }

      .nav-link-luxury {
        color: var(--text-luxury-light) !important;
        font-weight: 600 !important;
        padding: 12px 20px !important;
        border-radius: var(--radius-luxury-small) !important;
        transition: var(--transition-smooth) !important;
        text-decoration: none !important;
      }

      .nav-link-luxury:hover {
        background: rgba(212, 175, 55, 0.2) !important;
        color: var(--luxury-gold) !important;
      }

      .btn-luxury {
        background: var(--gradient-gold) !important;
        color: var(--luxury-black) !important;
        border: none !important;
        padding: 10px 20px !important;
        border-radius: var(--radius-luxury-small) !important;
        font-weight: 600 !important;
      }

      .btn-luxury-outline {
        background: transparent !important;
        color: var(--luxury-gold) !important;
        border: 2px solid var(--luxury-gold) !important;
      }

      .payment-header {
        text-align: center;
        margin-bottom: 40px;
        margin-top: 30px;
        position: relative;
        z-index: 1010;
      }

      .payment-title {
        font-size: 3rem;
        color: var(--luxury-gold);
        font-family: var(--font-luxury-primary);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        visibility: visible !important;
        opacity: 1 !important;
      }

      .payment-title::before {
        content: '\f3d1';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        font-size: 2.5rem;
      }

      .payment-title::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 150px;
        height: 3px;
        background: var(--gradient-gold);
        border-radius: 2px;
      }

      .dashboard-content {
        background: linear-gradient(135deg, var(--luxury-charcoal) 0%, var(--luxury-black) 100%);
        border-radius: var(--radius-luxury-large);
        box-shadow: var(--shadow-luxury);
        padding: 40px;
        border: 1px solid rgba(212, 175, 55, 0.2);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .dashboard-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-gold);
      }

      .payment-details {
        position: relative;
        z-index: 2;
      }

      .booking-summary {
        margin-bottom: 30px;
        padding: 25px;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
        border-radius: var(--radius-luxury-medium);
        border: 1px solid rgba(212, 175, 55, 0.3);
        position: relative;
      }

      .booking-summary::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-gold);
        border-radius: var(--radius-luxury-medium) var(--radius-luxury-medium) 0 0;
      }

      .booking-summary h3 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: var(--luxury-gold);
        font-family: var(--font-luxury-primary);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .booking-summary h3::before {
        content: '\f46c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        font-size: 1.5rem;
      }

      .booking-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }

      .info-item {
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: var(--radius-luxury-small);
        border: 1px solid rgba(212, 175, 55, 0.2);
        transition: var(--transition-smooth);
      }

      .info-item:hover {
        border-color: var(--luxury-gold);
        transform: translateY(-2px);
      }

      .info-label {
        font-weight: 600;
        color: var(--text-luxury-muted);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
      }

      .info-value {
        font-weight: 700;
        color: var(--text-luxury-light);
        font-size: 1.1rem;
      }

      .payment-methods {
        margin-top: 30px;
      }

      .payment-methods h3 {
        font-size: 1.8rem;
        margin-bottom: 25px;
        color: var(--luxury-gold);
        font-family: var(--font-luxury-primary);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .payment-methods h3::before {
        content: '\f09d';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        font-size: 1.5rem;
      }

      .payment-option {
        margin-bottom: 20px;
        padding: 25px;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, transparent 100%);
        border: 2px solid rgba(212, 175, 55, 0.2);
        border-radius: var(--radius-luxury-medium);
        cursor: pointer;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
      }

      .payment-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
        transition: left 0.5s;
      }

      .payment-option:hover::before {
        left: 100%;
      }

      .payment-option:hover {
        border-color: var(--luxury-gold);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(212, 175, 55, 0.2);
      }

      .payment-option.selected {
        border-color: var(--luxury-gold);
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.05) 100%);
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
      }

      .payment-option-header {
        display: flex;
        align-items: center;
        gap: 15px;
        position: relative;
        z-index: 2;
      }

      .payment-option-radio {
        width: 24px;
        height: 24px;
        accent-color: var(--luxury-gold);
        cursor: pointer;
      }

      .payment-option-title {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--luxury-gold);
        font-family: var(--font-luxury-primary);
      }

      .payment-option-details {
        margin-top: 12px;
        padding-left: 39px;
        font-size: 1rem;
        color: var(--text-luxury-muted);
        line-height: 1.5;
        position: relative;
        z-index: 2;
      }

      .card-details {
        margin-top: 20px;
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--radius-luxury-medium);
        border: 1px solid rgba(212, 175, 55, 0.2);
        display: none;
      }

      .form-group {
        margin-bottom: 20px;
        position: relative;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 1rem;
        color: var(--luxury-gold);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .form-control {
        width: 100%;
        padding: 15px 20px;
        font-size: 1rem;
        background: var(--luxury-black);
        border: 2px solid rgba(212, 175, 55, 0.3);
        border-radius: var(--radius-luxury-small);
        color: var(--text-luxury-light);
        transition: var(--transition-smooth);
        font-family: inherit;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--luxury-gold);
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        background: rgba(0, 0, 0, 0.8);
      }

      .form-control::placeholder {
        color: var(--text-luxury-muted);
        opacity: 0.7;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .total-section {
        margin-top: 40px;
        padding: 25px;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
        border-radius: var(--radius-luxury-medium);
        border: 2px solid rgba(212, 175, 55, 0.3);
        position: relative;
      }

      .total-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-gold);
        border-radius: var(--radius-luxury-medium) var(--radius-luxury-medium) 0 0;
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px 0;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
      }

      .total-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .total-label {
        font-weight: 600;
        color: var(--text-luxury-light);
        font-size: 1.1rem;
      }

      .total-value {
        font-weight: 700;
        color: var(--luxury-gold);
        font-size: 1.2rem;
        font-family: var(--font-luxury-primary);
      }

      .grand-total {
        font-size: 1.5rem;
        font-weight: 700;
        padding: 15px 0;
        border-top: 2px solid var(--luxury-gold);
        margin-top: 10px;
      }

      .grand-total .total-label {
        color: var(--luxury-gold);
        font-size: 1.3rem;
      }

      .grand-total .total-value {
        font-size: 1.8rem;
      }

      .btn {
        background: var(--gradient-gold);
        color: var(--luxury-black);
        border: none;
        padding: 15px 30px;
        border-radius: var(--radius-luxury-small);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: var(--transition-smooth);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        background: linear-gradient(135deg, #f4d03f 0%, #d4af37 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
      }

      .btn-cancel {
        background: transparent;
        color: var(--luxury-gold);
        border: 2px solid var(--luxury-gold);
      }

      .btn-cancel:hover {
        background: var(--luxury-gold);
        color: var(--luxury-black);
      }

      .action-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 40px;
      }

      /* Enhanced Footer */
      footer {
        margin-top: 60px;
        background: linear-gradient(135deg, var(--luxury-black) 0%, var(--luxury-charcoal) 50%, var(--luxury-black) 100%);
        color: var(--text-luxury-light);
        font-size: 1rem;
        padding: 40px 0;
        border-top: 2px solid var(--luxury-gold);
        position: relative;
        text-align: center;
      }

      footer::before {
        content: '';
        position: absolute;
        top: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 2px;
        background: var(--gradient-gold);
        border-radius: 2px;
      }

      footer p {
        margin: 0;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      footer p::before {
        content: '\f3fd';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        color: var(--luxury-gold);
        font-size: 1.2em;
      }

      footer p::after {
        content: '\f3fd';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        color: var(--luxury-gold);
        font-size: 1.2em;
      }

      .message {
        padding: 20px;
        border-radius: var(--radius-luxury-medium);
        margin-bottom: 30px;
        font-size: 1.1rem;
        font-weight: 600;
        border: 2px solid;
        position: relative;
        z-index: 1020;
        margin-top: 20px;
      }

      .message.error {
        background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(231, 76, 60, 0.05) 100%);
        color: #e74c3c;
        border-color: rgba(231, 76, 60, 0.5);
      }

      .message.success {
        background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(46, 204, 113, 0.05) 100%);
        color: #27ae60;
        border-color: rgba(46, 204, 113, 0.5);
      }

      /* Message Container Positioning */
      #message-container {
        position: relative;
        z-index: 1020;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      #message-container .message {
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .booking-info {
          grid-template-columns: 1fr;
        }
        
        .form-row {
          grid-template-columns: 1fr;
        }
        
        .action-buttons {
          flex-direction: column;
        }
        
        .payment-title {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Page Loader -->
    <div class="page-loader">
      <div class="loader-content">
        <div class="loader-spinner"></div>
        <div class="loader-text">VeloRent Payment</div>
      </div>
    </div>

    

    <div class="container">
      <main>
        <div id="message-container" style="margin-top: 20px; position: relative; z-index: 1020;"></div>

        <div class="payment-header">
          <h1 class="payment-title" id="payment-title">Complete Your Payment</h1>
        </div>

        <div class="dashboard-content">
          <div class="payment-details">
            <div class="booking-summary">
              <h3 id="summary-title">Booking Summary</h3>
              <div class="booking-info" id="booking-info-grid">
                <div class="info-item" id="vehicle-row">
                  <div class="info-label">Vehicle:</div>
                  <div class="info-value" id="vehicle-name">Vehicle name here</div>
                </div>
                <div class="info-item" id="booking-id-row">
                  <div class="info-label">Booking ID:</div>
                  <div class="info-value" id="booking-id">Not yet assigned</div>
                </div>
                <div class="info-item" id="start-date-row">
                  <div class="info-label">Start Date:</div>
                  <div class="info-value" id="start-date">Date here</div>
                </div>
                <div class="info-item" id="end-date-row">
                  <div class="info-label">End Date:</div>
                  <div class="info-value" id="end-date">Date here</div>
                </div>
                <div class="info-item" id="duration-row">
                  <div class="info-label">Duration:</div>
                  <div class="info-value" id="duration">0 days</div>
                </div>
                <div class="info-item" id="rate-row">
                  <div class="info-label">Daily Rate:</div>
                  <div class="info-value" id="daily-rate">Rs. 0.00</div>
                </div>
              </div>
            </div>

            <div class="payment-methods">
              <h3>Select Payment Method</h3>
              <div class="payment-option selected" id="card-payment-option">
                <div class="payment-option-header">
                  <input type="radio" name="payment-method" value="card" class="payment-option-radio" checked>
                  <div class="payment-option-title">Credit / Debit Card</div>
                </div>
                <div class="payment-option-details">
                  Pay securely with your credit or debit card. We accept Visa, MasterCard, and American Express.
                </div>
                <div class="card-details" id="card-details" style="display: block;">
                  <div class="form-group">
                    <label for="card-number">Card Number</label>
                    <input type="text" id="card-number" class="form-control" placeholder="1234 5678 9012 3456">
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="expiry-date">Expiry Date (MM/YY)</label>
                      <input type="text" id="expiry-date" class="form-control" placeholder="MM/YY">
                    </div>
                    <div class="form-group">
                      <label for="cvv">CVV</label>
                      <input type="text" id="cvv" class="form-control" placeholder="123">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="card-name">Cardholder Name</label>
                    <input type="text" id="card-name" class="form-control" placeholder="John Doe">
                  </div>
                </div>
              </div>

              <div class="payment-option" id="cash-payment-option">
                <div class="payment-option-header">
                  <input type="radio" name="payment-method" value="cash" class="payment-option-radio">
                  <div class="payment-option-title">Pay with Cash</div>
                </div>
                <div class="payment-option-details">
                  Pay in cash when you pick up the vehicle. Your booking will be marked as "pending" until payment is received.
                </div>
              </div>
            </div>

            <div class="total-section">
              <div class="total-row">
                <div class="total-label">Subtotal:</div>
                <div class="total-value" id="subtotal">Rs. 0.00</div>
              </div>
              <div class="total-row">
                <div class="total-label">Tax (18%):</div>
                <div class="total-value" id="tax">Rs. 0.00</div>
              </div>
              <div class="total-row grand-total">
                <div class="total-label">Total Amount:</div>
                <div class="total-value" id="total-amount">Rs. 0.00</div>
              </div>
            </div>

            <div class="action-buttons">
              <a href="/dashboard" class="btn btn-cancel"><i class="fas fa-arrow-left"></i>Cancel</a>
              <button id="confirm-payment-btn" class="btn"><i class="fas fa-credit-card"></i>Confirm Payment</button>
            </div>
          </div>
        </div>
      </main>

      <footer>
        <p>&copy; 2025 <span style="color: var(--luxury-gold); font-weight: 700; font-family: var(--font-luxury-primary);">VeloRent</span> - Luxury Car Rental System. All rights reserved.</p>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Check if user is logged in
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login?message=" + encodeURIComponent("Please log in to access the payment page") + "&type=error";
          return;
        }

        const params = new URLSearchParams(window.location.search);
        const isPackageMode = params.get('mode') === 'package';

        // Ensure we have user/customer identifiers in localStorage
        async function ensureUserIdentifiers() {
          const haveUserId = !!localStorage.getItem("userId");
          const haveCustomerId = !!localStorage.getItem("customerId");
          if (haveUserId && haveCustomerId) return; // already present
          try {
            const res = await fetch('/api/auth/me', {
              method: 'GET',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) return;
            const json = await res.json();
            if (json && json.success && json.data) {
              if (json.data.userId) localStorage.setItem('userId', json.data.userId);
              if (json.data.userEmail) localStorage.setItem('userEmail', json.data.userEmail);
              if (json.data.userName) localStorage.setItem('userName', json.data.userName);
              if (json.data.customerId) localStorage.setItem('customerId', json.data.customerId);
            }
          } catch (_) { /* ignore */ }
        }

        // Kick off identifiers fetch (non-blocking)
        ensureUserIdentifiers();

        // Toggle payment options
        const cardOption = document.getElementById("card-payment-option");
        const cashOption = document.getElementById("cash-payment-option");
        const cardDetails = document.getElementById("card-details");

        cardOption.addEventListener("click", () => {
          cardOption.classList.add("selected");
          cashOption.classList.remove("selected");
          cardOption.querySelector("input").checked = true;
          cardDetails.style.display = "block";
        });

        cashOption.addEventListener("click", () => {
          cashOption.classList.add("selected");
          cardOption.classList.remove("selected");
          cashOption.querySelector("input").checked = true;
          cardDetails.style.display = "none";
        });

        // Set user initials in profile icon if available
        const userName = localStorage.getItem("userName") || "User";
        const userInitials = userName
          .split(" ")
          .map((n) => n.charAt(0))
          .join("")
          .toUpperCase();
        const initialsEl = document.getElementById("user-initials");
        if (initialsEl) initialsEl.textContent = userInitials;

        function setTotals(subtotal) {
          document.getElementById("subtotal").textContent = `Rs. ${Number(subtotal).toFixed(2)}`;
          const tax = Number(subtotal) * 0.18;
          document.getElementById("tax").textContent = `Rs. ${tax.toFixed(2)}`;
          const totalAmount = Number(subtotal) + tax;
          document.getElementById("total-amount").textContent = `Rs. ${totalAmount.toFixed(2)}`;
          return totalAmount;
        }

        if (isPackageMode) {
          // Package purchase flow
          document.getElementById('payment-title').textContent = 'Purchase Package';
          document.getElementById('summary-title').textContent = 'Package Summary';

          const pkg = JSON.parse(localStorage.getItem('selectedPackage'));
          if (!pkg) {
            window.location.href = "/dashboard?message=" + encodeURIComponent("Package selection not found. Please try again.") + "&type=error";
            return;
          }

          // Debug logging to see what we received
          console.log("PAYMENT DEBUG - pkg object:", pkg);
          console.log("PAYMENT DEBUG - pkg.price:", pkg.price);
          console.log("PAYMENT DEBUG - pkg.totalCost:", pkg.totalCost);

          // Fill in summary
          document.getElementById('vehicle-name').textContent = `${pkg.packageName} (${pkg.duration} days)`;
          // Hide irrelevant rows
          ['booking-id-row','start-date-row','end-date-row','duration-row','rate-row'].forEach(id => {
            const el = document.getElementById(id); if (el) el.style.display = 'none';
          });

          // Fix the price calculation - extract numeric value properly
          let finalAmount = 0;

          // First try to get the total cost from pending package booking
          const packageBookingData = JSON.parse(localStorage.getItem('pendingPackageBooking') || '{}');
          console.log("PAYMENT DEBUG - packageBookingData:", packageBookingData);

          if (packageBookingData && packageBookingData.totalCost) {
            finalAmount = Number(packageBookingData.totalCost);
            console.log("PAYMENT DEBUG - Using totalCost from packageBookingData:", finalAmount);
          }
          // If not available, try from selectedPackage totalCost (duration-calculated)
          else if (pkg && pkg.totalCost && pkg.totalCost > 0) {
            finalAmount = Number(pkg.totalCost);
            console.log("PAYMENT DEBUG - Using totalCost from pkg:", finalAmount);
          }
          // Only fall back to base price if no total cost is available
          else if (pkg && pkg.price) {
            // Handle different price formats
            let priceValue = pkg.price;
            console.log("PAYMENT DEBUG - Raw price value:", priceValue, "Type:", typeof priceValue);

            if (typeof priceValue === 'string') {
              // Remove any currency symbols and extract numbers
              const cleanPrice = priceValue.replace(/[^\d.]/g, '');
              console.log("PAYMENT DEBUG - Cleaned price string:", cleanPrice);
              finalAmount = Number(cleanPrice);
            } else if (typeof priceValue === 'number') {
              finalAmount = priceValue;
            }

            // If we're using base price, multiply by duration to get total cost
            if (pkg.duration && pkg.duration > 0) {
              finalAmount = finalAmount * Number(pkg.duration);
              console.log("PAYMENT DEBUG - Multiplied by duration:", pkg.duration, "Result:", finalAmount);
            }

            console.log("PAYMENT DEBUG - Using calculated price from pkg:", finalAmount);
          }
          else {
            // Try to extract from package name or other fields
            console.log("PAYMENT DEBUG - No price found, checking package name:", pkg.packageName);

            // Look for any numeric values in the package object that could be total costs
            const packageKeys = Object.keys(pkg);
            for (let key of packageKeys) {
              const value = pkg[key];
              // Prioritize larger values that could be total costs
              if (typeof value === 'number' && value > 50000 && value < 1000000) {
                console.log(`PAYMENT DEBUG - Found potential total cost in ${key}:`, value);
                finalAmount = value;
                break;
              }
            }

            // If still no value, look for smaller values and multiply by duration
            if (finalAmount === 0) {
              for (let key of packageKeys) {
                const value = pkg[key];
                if (typeof value === 'number' && value > 1000 && value < 50000) {
                  console.log(`PAYMENT DEBUG - Found potential base price in ${key}:`, value);
                  finalAmount = value * (pkg.duration || 5); // Default to 5 days if duration missing
                  break;
                }
                if (typeof value === 'string') {
                  const numMatch = value.match(/\d+/);
                  if (numMatch && Number(numMatch[0]) > 1000) {
                    console.log(`PAYMENT DEBUG - Found potential price in ${key}:`, numMatch[0]);
                    finalAmount = Number(numMatch[0]) * (pkg.duration || 5);
                    break;
                  }
                }
              }
            }

            // Last resort - set default based on package type and multiply by duration
            if (finalAmount === 0) {
              const duration = pkg.duration || 5;
              if (pkg.packageName && pkg.packageName.toLowerCase().includes('wedding')) {
                finalAmount = 25000 * duration;
                console.log("PAYMENT DEBUG - Using wedding package default with duration:", finalAmount);
              } else if (pkg.packageName && pkg.packageName.toLowerCase().includes('business')) {
                finalAmount = 15000 * duration;
                console.log("PAYMENT DEBUG - Using business package default with duration:", finalAmount);
              } else {
                finalAmount = 10000 * duration;
                console.log("PAYMENT DEBUG - Using generic package default with duration:", finalAmount);
              }
            }
          }

          // Final validation - ensure we have a reasonable amount
          if (isNaN(finalAmount) || finalAmount <= 0) {
            console.error("PAYMENT ERROR - finalAmount is invalid:", finalAmount);
            const duration = pkg.duration || 5;
            finalAmount = 25000 * duration; // Safe default with duration
          }

          console.log("PAYMENT DEBUG - Final calculated amount:", finalAmount);

          // Totals from package price
          const totalAmount = setTotals(finalAmount);

          document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
            // Get selected payment method
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

            // If card payment, validate card details
            if (paymentMethod === "card") {
              const cardNumber = document.getElementById("card-number").value;
              const expiryDate = document.getElementById("expiry-date").value;
              const cvv = document.getElementById("cvv").value;
              const cardName = document.getElementById("card-name").value;

              if (!cardNumber || !expiryDate || !cvv || !cardName) {
                showMessage("Please fill in all card details.", "error");
                return;
              }
              if (cardNumber.replace(/\s/g, '').length !== 16) {
                showMessage("Please enter a valid 16-digit card number.", "error");
                return;
              }
              if (!/^\d{3,4}$/.test(cvv)) {
                showMessage("Please enter a valid CVV.", "error");
                return;
              }
              if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
                showMessage("Please enter a valid expiry date (MM/YY).", "error");
                return;
              }
            }

            try {
              // Disable button to prevent multiple submissions
              const confirmBtn = document.getElementById('confirm-payment-btn');
              confirmBtn.disabled = true;
              confirmBtn.textContent = 'Processing...';

              // Get package booking data from localStorage
              const packageBookingData = JSON.parse(localStorage.getItem('pendingPackageBooking'));
              if (!packageBookingData) {
                showMessage("Package booking data not found. Please try again.", "error");
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Payment';
                return;
              }

              // If we already have a booking created (from packages page), process payment on it
              const urlParams = new URLSearchParams(window.location.search);
              const existingBookingId = urlParams.get('bookingId') || packageBookingData.bookingId;

              if (existingBookingId) {
                console.log('Processing payment for existing package booking:', existingBookingId);
                const payRes = await fetch(`/api/bookings/package/${existingBookingId}/payment`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    paymentMethod,
                    transactionId: paymentMethod === 'card' ? `CARD-${Date.now()}` : undefined
                  })
                });

                const payText = await payRes.text();
                console.log('Package payment response:', payText);
                let payJson;
                try { payJson = JSON.parse(payText); } catch(e) { throw new Error('Invalid payment response format'); }
                if (!payRes.ok || !payJson.success) {
                  throw new Error(payJson.message || 'Failed to process payment for booking');
                }

                showMessage(`Payment ${paymentMethod === 'card' ? 'completed' : 'recorded (pending)'}! Redirecting to dashboard...`, 'success');
                // Clear local storage keys related to package flow
                localStorage.removeItem('selectedPackage');
                localStorage.removeItem('pendingPackageBooking');

                setTimeout(() => {
                  window.location.href = "/dashboard?message=" +
                    encodeURIComponent(`Your package has been ${paymentMethod === 'card' ? 'confirmed' : 'placed and is pending payment'}.`) +
                    "&type=success";
                }, 1500);
                return;
              }

              // Fallback: no existing booking, create booking with payment in one step
              console.log("Creating package booking with payment:", JSON.stringify(packageBookingData));
              const response = await fetch('/api/bookings/package/with-payment', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                body: JSON.stringify({
                  packageId: parseInt(packageBookingData.packageId),
                  startDate: packageBookingData.startDate + 'T00:00:00',
                  endDate: packageBookingData.endDate + 'T00:00:00',
                  paymentMethod: paymentMethod
                })
              });

              // Parse response
              const responseText = await response.text();
              console.log("Raw unified response:", responseText);

              let result;
              try {
                result = JSON.parse(responseText);
              } catch (e) {
                console.error("Error parsing response:", e);
                throw new Error("Invalid response format");
              }

              if (!response.ok) {
                throw new Error('Package booking failed: ' + (result.message || 'Unknown error'));
              }

              // Handle successful booking and payment
              showMessage("Package purchase successful! Redirecting to dashboard...", "success");

              // Clear package data from localStorage
              localStorage.removeItem('selectedPackage');
              localStorage.removeItem('pendingPackageBooking');

              // Redirect after a short delay
              setTimeout(() => {
                window.location.href = "/dashboard?message=" +
                  encodeURIComponent("Your package has been purchased successfully!") +
                  "&type=success";
              }, 2000);

            } catch (error) {
              console.error('Error during package booking/payment:', error);
              showMessage(error.message || "An error occurred. Please try again later.", "error");
              document.getElementById('confirm-payment-btn').disabled = false;
              document.getElementById('confirm-payment-btn').textContent = 'Confirm Payment';
            }
          });

          // Done setting up package mode
          return;
        }

        // Vehicle booking payment flow (existing)
        const bookingData = JSON.parse(localStorage.getItem("pendingBooking"));
        const vehicleData = JSON.parse(localStorage.getItem("selectedVehicle"));

        if (!bookingData || !vehicleData) {
          window.location.href = "/dashboard?message=" + encodeURIComponent("Booking data not found. Please try again.") + "&type=error";
          return;
        }

        // Fill in booking summary
        document.getElementById("vehicle-name").textContent = `${vehicleData.make} ${vehicleData.model} (${vehicleData.year})`;

        // Format dates for display
        const startDate = new Date(bookingData.startDate);
        const endDate = new Date(bookingData.endDate);
        document.getElementById("start-date").textContent = startDate.toLocaleDateString();
        document.getElementById("end-date").textContent = endDate.toLocaleDateString();

        // Calculate duration
        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        document.getElementById("duration").textContent = `${duration} days`;

        // Display rate
        const dailyRate = vehicleData.has_discount ? vehicleData.discountedRatePerDay : vehicleData.rentalRatePerDay;
        document.getElementById("daily-rate").textContent = `Rs. ${dailyRate}`;

        // Calculate totals
        const subtotal = bookingData.totalCost;
        const totalAmount = setTotals(subtotal);

        // Handle payment submission
        document.getElementById("confirm-payment-btn").addEventListener("click", async () => {
          // Get selected payment method
          const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

          // If card payment, validate card details
          if (paymentMethod === "card") {
            const cardNumber = document.getElementById("card-number").value;
            const expiryDate = document.getElementById("expiry-date").value;
            const cvv = document.getElementById("cvv").value;
            const cardName = document.getElementById("card-name").value;

            if (!cardNumber || !expiryDate || !cvv || !cardName) {
              showMessage("Please fill in all card details.", "error");
              return;
            }

            // Basic validation
            if (cardNumber.replace(/\s/g, '').length !== 16) {
              showMessage("Please enter a valid 16-digit card number.", "error");
              return;
            }

            if (!/^\d{3,4}$/.test(cvv)) {
              showMessage("Please enter a valid CVV.", "error");
              return;
            }

            if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
              showMessage("Please enter a valid expiry date (MM/YY).", "error");
              return;
            }
          }

          try {
            // Disable button to prevent multiple submissions
            const confirmBtn = document.getElementById("confirm-payment-btn");
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Processing...";

            // Determine correct ID to send (BookingService expects USER ID under bookingData.customerId)
            let storedCustomerId = localStorage.getItem("customerId");
            let storedUserId = localStorage.getItem("userId");
            let idToUse = bookingData.customerId || storedCustomerId || storedUserId;

            // If missing, try to fetch from /api/auth/me and re-check
            if (!idToUse) {
              await ensureUserIdentifiers();
              storedCustomerId = localStorage.getItem("customerId");
              storedUserId = localStorage.getItem("userId");
              idToUse = bookingData.customerId || storedCustomerId || storedUserId;
            }

            if (!idToUse) {
              showMessage("Customer ID not found. Please try logging in again.", "error");
              confirmBtn.disabled = false;
              confirmBtn.textContent = "Confirm Payment";
              return;
            }

            // Ensure numeric
            bookingData.customerId = parseInt(idToUse);

            console.log("Creating booking with data:", JSON.stringify(bookingData));
            const bookingResponse = await fetch('/api/bookings', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              // Normalize payload: LocalDateTime format and numeric ids/amounts
              body: JSON.stringify({
                startDate: (typeof bookingData.startDate === 'string' && !bookingData.startDate.includes('T'))
                  ? `${bookingData.startDate}T00:00:00`
                  : bookingData.startDate,
                endDate: (typeof bookingData.endDate === 'string' && !bookingData.endDate.includes('T'))
                  ? `${bookingData.endDate}T00:00:00`
                  : bookingData.endDate,
                totalCost: (typeof bookingData.totalCost === 'string') ? Number(bookingData.totalCost) : bookingData.totalCost,
                vehicleId: parseInt(bookingData.vehicleId, 10),
                customerId: parseInt(bookingData.customerId, 10)
              })
            });

            // Log the raw response for debugging
            const bookingResponseText = await bookingResponse.text();
            console.log("Raw booking response:", bookingResponseText);

            // Parse the response
            let bookingResult;
            try {
              bookingResult = JSON.parse(bookingResponseText);
            } catch (e) {
              console.error("Error parsing booking response:", e);
              throw new Error("Invalid booking response format");
            }

            if (!bookingResponse.ok) {
              throw new Error('Booking failed: ' + (bookingResult.message || 'Unknown error'));
            }

            // Extract bookingId from payload which is { success, booking: { bookingId, ... } }
            const bookingPayload = bookingResult.booking || bookingResult;
            const createdBookingId = bookingPayload.bookingId;
            if (!createdBookingId) {
              showMessage("Booking creation failed. No booking ID returned.", "error");
              confirmBtn.disabled = false;
              confirmBtn.textContent = "Confirm Payment";
              return;
            }

            // Update booking ID display
            document.getElementById("booking-id").textContent = createdBookingId;

            // Now process payment
            const paymentRequest = {
              bookingId: createdBookingId,
              paymentMethod: paymentMethod,
              amount: totalAmount.toFixed(2)
            };

            console.log("Processing payment with data:", JSON.stringify(paymentRequest));
            const paymentResponse = await fetch('/api/payments', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(paymentRequest)
            });

            // Log the raw response for debugging
            const paymentResponseText = await paymentResponse.text();
            console.log("Raw payment response:", paymentResponseText);

            // Parse the response
            let paymentResult;
            try {
              paymentResult = JSON.parse(paymentResponseText);
            } catch (e) {
              console.error("Error parsing payment response:", e);
              throw new Error("Invalid payment response format");
            }

            if (!paymentResponse.ok) {
              throw new Error('Payment failed: ' + (paymentResult.message || 'Unknown error'));
            }

            // Handle successful payment
            showMessage("Payment processed successfully! Redirecting to dashboard...", "success");

            // Clear booking data from localStorage
            localStorage.removeItem("pendingBooking");
            localStorage.removeItem("selectedVehicle");

            // Redirect after a short delay
            setTimeout(() => {
              window.location.href = "/dashboard?message=" +
                encodeURIComponent(`Your booking has been ${paymentMethod === 'card' ? 'confirmed' : 'placed and is pending payment'}.`) +
                "&type=success";
            }, 2000);

          } catch (error) {
            console.error('Error during booking/payment:', error);
            showMessage(error.message || "An error occurred. Please try again later.", "error");
            document.getElementById("confirm-payment-btn").disabled = false;
            document.getElementById("confirm-payment-btn").textContent = "Confirm Payment";
          }
        });

        // Helper function to show messages
        function showMessage(message, type) {
          const messageContainer = document.getElementById("message-container");
          messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;
          
          // Ensure the message container is visible
          messageContainer.style.display = 'block';
          messageContainer.style.position = 'relative';
          messageContainer.style.zIndex = '1020';
          
          // Scroll to top to show message, accounting for fixed navbar
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
          // Auto-hide message after 5 seconds
          setTimeout(() => {
            const messageElement = messageContainer.querySelector('.message');
            if (messageElement) {
              messageElement.style.opacity = '0';
              messageElement.style.transition = 'opacity 0.5s ease-out';
              setTimeout(() => {
                messageContainer.innerHTML = '';
              }, 500);
            }
          }, 5000);
        }


        // Setup logout button
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = "/login?message=" + encodeURIComponent("You have been logged out") + "&type=success";
          });
        }
      });
    </script>

    <!-- Luxury Theme Scripts -->
    <script src="/js/luxury-theme.js"></script>
    <script src="/js/luxury-theme-enhancer.js"></script>
  </body>
</html>
