<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rental History | Car Rental System</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #2ecc71;
      --text-color: #333;
      --light-text: #666;
      --background-color: #f8f9fa;
      --card-background: #fff;
      --border-color: #e1e1e1;
      --danger-color: #e74c3c;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto','Segoe UI',Arial,sans-serif; }
    body { background-color: var(--background-color); color: var(--text-color); }
    header { background-color: var(--primary-color); color: #fff; padding: 1rem; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    nav { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.5rem; font-weight: bold; }
    .nav-links { display: flex; gap: 20px; align-items: center; }
    .nav-links a { color: #fff; text-decoration: none; padding: 8px 15px; border-radius: 4px; }
    .nav-links a:hover { background: rgba(255,255,255,.1); }
    h1 { color: var(--primary-color); margin-bottom: 15px; }
    .card { background: var(--card-background); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); padding: 16px; margin-bottom: 18px; }
    .section-title { font-size: 18px; margin-bottom: 10px; }
    .message { padding: 12px; border-radius: 4px; margin-bottom: 16px; font-size: 14px; }
    .message.error { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border: 1px solid rgba(231,76,60,.3); }
    .message.success { background: rgba(46, 204, 113, 0.1); color: #27ae60; border: 1px solid rgba(46,204,113,.3); }
    .btn { background: var(--primary-color); color: #fff; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .btn:hover { background: #34495e; }
    .btn-accent { background: var(--accent-color); }
    .btn-accent:hover { background: #27ae60; }
    .btn-light { background: #95a5a6; }
    .actions { display: flex; gap: 8px; }
    footer { margin-top: 40px; text-align: center; color: var(--light-text); font-size: 14px; padding: 20px; border-top: 1px solid var(--border-color); }

    /* Rental history cards grid layout */
    .rentals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .rental-card {
      background-color: var(--card-background);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      padding: 0;
      transition: transform 0.3s;
      position: relative;
      overflow: hidden;
    }

    .rental-card:hover {
      transform: translateY(-5px);
    }

    .rental-card.current {
      border-left: 4px solid var(--accent-color);
    }

    .rental-card.past {
      border-left: 4px solid var(--secondary-color);
    }

    .rental-card.cancelled {
      border-left: 4px solid var(--danger-color);
    }

    .vehicle-image-container {
      width: 100%;
      height: 160px;
      overflow: hidden;
      position: relative;
      background-color: #f1f1f1;
    }

    .vehicle-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .vehicle-image-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      font-size: 48px;
    }

    .rental-card-content {
      padding: 16px;
      position: relative;
    }

    .rental-card .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      color: white;
    }

    .rental-card .status-badge.confirmed {
      background-color: var(--accent-color);
    }

    .rental-card .status-badge.payment-pending {
      background-color: var(--secondary-color);
    }

    .rental-card .status-badge.returned {
      background-color: #95a5a6;
    }

    .rental-card .status-badge.cancelled {
      background-color: var(--danger-color);
    }

    .rental-card .vehicle-title {
      font-weight: 500;
      font-size: 18px;
      margin-bottom: 12px;
      padding-right: 80px; /* Space for the badge */
    }

    .rental-card .booking-id {
      position: absolute;
      top: 10px;
      left: 16px;
      font-size: 12px;
      color: var(--light-text);
    }

    .rental-card .detail-row {
      display: flex;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .rental-card .detail-label {
      width: 90px;
      color: var(--light-text);
      font-weight: 500;
    }

    .rental-card .detail-value {
      flex: 1;
    }

    .rental-card .price {
      font-size: 18px;
      font-weight: 700;
      margin: 12px 0;
      color: var(--primary-color);
    }

    .rental-card .date-range {
      background-color: var(--background-color);
      padding: 8px;
      border-radius: 4px;
      margin: 10px 0;
      text-align: center;
      font-size: 14px;
    }

    .rental-card .card-actions {
      margin-top: 15px;
      text-align: right;
    }

    .empty-message {
      text-align: center;
      padding: 30px;
      color: var(--light-text);
      font-size: 16px;
      background: var(--card-background);
      border-radius: 8px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <nav>
      <div class="logo">Car Rental System</div>
      <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/feedback">About Us</a>
        <a href="/security-settings">Security</a>
        <a href="#" id="logout-btn">Logout</a>
      </div>
    </nav>
  </div>
</header>

<div class="container">
  <div id="message-container"></div>

  <h1>Rental History</h1>

  <div class="card">
    <div class="section-title">Currently Rented Vehicles</div>
    <div id="current-empty" class="empty-message" style="display:none;">No active rentals right now.</div>
    <div id="current-rentals" class="rentals-grid">
      <!-- Current rental cards will be inserted here dynamically -->
    </div>
  </div>

  <div class="card">
    <div class="section-title">Past Rentals</div>
    <div id="past-empty" class="empty-message" style="display:none;">No past rentals yet.</div>
    <div id="past-rentals" class="rentals-grid">
      <!-- Past rental cards will be inserted here dynamically -->
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Car Rental System. All rights reserved.</p>
  </footer>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login?message=' + encodeURIComponent('Please log in to view rental history') + '&type=error';
      return;
    }

    const messageContainer = document.getElementById('message-container');
    function showMessage(text, type = 'info') {
      messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Logout
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.clear();
      window.location.href = '/login?message=' + encodeURIComponent('You have been logged out') + '&type=success';
    });

    // Ensure we have identifiers
    async function ensureIds() {
      let userId = localStorage.getItem('userId');
      let customerId = localStorage.getItem('customerId');
      if (userId && customerId) return { userId, customerId };
      try {
        const res = await fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}` }});
        if (res.ok) {
          const json = await res.json();
          if (json.success && json.data) {
            if (json.data.userId) localStorage.setItem('userId', json.data.userId);
            if (json.data.customerId) localStorage.setItem('customerId', json.data.customerId);
            userId = json.data.userId || userId;
            customerId = json.data.customerId || customerId;
          }
        }
      } catch {}
      return { userId: localStorage.getItem('userId'), customerId: localStorage.getItem('customerId') };
    }

    // Load bookings
    (async function loadBookings() {
      const { userId } = await ensureIds();
      if (!userId) {
        showMessage('Could not determine your account. Please login again.', 'error');
        return;
      }
      try {
        // Use summary endpoint to avoid serialization issues
        const res = await fetch(`/api/bookings/customer/${userId}/summary`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });
        if (!res.ok) throw new Error('Failed to load bookings');
        const bookings = await res.json();
        renderBookings(Array.isArray(bookings) ? bookings : []);
      } catch (e) {
        console.error(e);
        showMessage('Failed to load your bookings. Please try again later.', 'error');
      }
    })();

    function renderBookings(bookings) {
      const current = [];
      const past = [];

      bookings.forEach(b => {
        const status = (b.bookingStatus || '').toLowerCase();
        if (status === 'returned' || status === 'cancelled') past.push(b); else current.push(b);
      });

      // Current rentals
      const currentRentals = document.getElementById('current-rentals');
      currentRentals.innerHTML = '';
      if (current.length === 0) {
        document.getElementById('current-empty').style.display = 'block';
      } else {
        document.getElementById('current-empty').style.display = 'none';
        current.forEach(booking => {
          const card = createRentalCard(booking, true);
          currentRentals.appendChild(card);
        });
      }

      // Past rentals
      const pastRentals = document.getElementById('past-rentals');
      pastRentals.innerHTML = '';
      if (past.length === 0) {
        document.getElementById('past-empty').style.display = 'block';
      } else {
        document.getElementById('past-empty').style.display = 'none';
        past.forEach(booking => {
          const card = createRentalCard(booking, false);
          pastRentals.appendChild(card);
        });
      }
    }

    function createRentalCard(booking, isCurrent) {
      const card = document.createElement('div');
      card.className = `rental-card ${isCurrent ? 'current' : 'past'}`;

      // Determine status class for badge
      const status = (booking.bookingStatus || '').toLowerCase();
      let statusClass = 'confirmed';
      if (status === 'payment pending') statusClass = 'payment-pending';
      else if (status === 'returned') statusClass = 'returned';
      else if (status === 'cancelled') statusClass = 'cancelled';

      const vehicleTitle = `${booking.vehicleMake || ''} ${booking.vehicleModel || ''}`.trim() || 'Vehicle';

      // Format dates
      const startDate = formatDate(booking.startDate);
      const endDate = formatDate(booking.endDate);

      // Create card content
      card.innerHTML = `
        <div class="status-badge ${statusClass}">${booking.bookingStatus || ''}</div>
        <p class="booking-id">Booking #${booking.bookingId}</p>
        <h3 class="vehicle-title">${vehicleTitle}</h3>

        <div class="vehicle-image-container">
          ${booking.imageUrl ? `
            <img src="${booking.imageUrl}" alt="${vehicleTitle}" class="vehicle-image" onerror="handleImageError(this)" />
          ` : `
            <div class="vehicle-image-placeholder">No Image</div>
          `}
        </div>

        <div class="date-range">
          ${startDate} — ${endDate}
        </div>

        <div class="detail-row">
          <div class="detail-label">Registration:</div>
          <div class="detail-value">${booking.registrationNumber || 'N/A'}</div>
        </div>

        <div class="price">Rs. ${booking.totalCost || '0'}</div>

        ${isCurrent ? `
          <div class="card-actions">
            <button class="btn btn-accent return-btn" data-id="${booking.bookingId}">Return Vehicle</button>
          </div>
        ` : ''}
      `;

      // Add event listener to return button if current booking
      if (isCurrent) {
        const returnBtn = card.querySelector('.return-btn');
        returnBtn.addEventListener('click', () => handleReturnVehicle(booking.bookingId, returnBtn));
      }

      return card;
    }

    async function handleReturnVehicle(bookingId, button) {
      button.disabled = true;
      button.textContent = 'Processing...';
      try {
        const res = await fetch(`/api/bookings/${bookingId}/return`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        const text = await res.text();
        let json = {};
        try { json = text ? JSON.parse(text) : {}; } catch (_) { json = {}; }
        if (!res.ok || (json.success === false)) throw new Error(json.message || 'Failed');
        showMessage(json.message || 'Vehicle returned successfully', 'success');
        // Reload list
        setTimeout(() => { window.location.reload(); }, 800);
      } catch (e) {
        console.error(e);
        showMessage(e.message || 'Failed to return vehicle', 'error');
        button.disabled = false;
        button.textContent = 'Return Vehicle';
      }
    }

    function formatDate(val) {
      if (!val) return '';
      try {
        const date = new Date(val);
        return date.toLocaleDateString('en-US', {
          day: 'numeric',
          month: 'short',
          year: 'numeric'
        });
      } catch {
        return val;
      }
    }

    // Image fallback handler
    window.handleImageError = function(imgEl) {
      const container = imgEl && imgEl.parentElement;
      if (container) {
        container.innerHTML = '<div class="vehicle-image-placeholder">No Image</div>';
      }
    }
  });
</script>
</body>
</html>
