<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Packages | Fleet Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="/js/jQuery/jquery-3.7.1.min.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #2ecc71;
      --danger-color: #e74c3c;
      --text-color: #333;
      --light-text: #666;
      --background-color: #f8f9fa;
      --card-background: #fff;
      --border-color: #e1e1e1;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Roboto", "Segoe UI", Arial, sans-serif; }
    body { background-color: var(--background-color); color: var(--text-color); }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { background-color: var(--primary-color); color: white; padding: 1rem; }
    nav { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
    .nav-links { display: flex; gap: 10px; }
    .nav-links a { color: white; text-decoration: none; padding: 8px 12px; border-radius: 4px; }
    .nav-links a:hover { background-color: rgba(255,255,255,0.1); }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
    .btn { background-color: var(--primary-color); color: #fff; border: none; padding: 10px 14px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; text-decoration: none; }
    .btn:hover { background-color: #34495e; }
    .btn-accent { background: var(--accent-color); }
    .btn-accent:hover { background: #27ae60; }
    .btn-danger { background: var(--danger-color); }
    .btn-danger:hover { background: #c0392b; }

    .card { background: var(--card-background); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); padding: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background: var(--primary-color); color: #fff; font-weight: 500; }
    tr:nth-child(even) { background: rgba(0,0,0,0.02); }

    .status { padding: 4px 10px; border-radius: 12px; font-size: 12px; display: inline-block; }
    .status.active { background: rgba(46,204,113,.15); color: #27ae60; }
    .status.inactive { background: rgba(231,76,60,.15); color: #c0392b; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 100; }
    .modal .content { background: #fff; width: 95%; max-width: 720px; margin: 40px auto; border-radius: 8px; padding: 18px; }
    .modal .header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .modal h3 { margin: 0; font-size: 18px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-group { display:flex; flex-direction: column; gap: 6px; }
    .form-group label { font-weight: 500; }
    .form-group input, .form-group select { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; }
    .vehicle-list { max-height: 220px; overflow: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; }
    .image-preview { height: 140px; border: 1px dashed var(--border-color); display:flex; align-items: center; justify-content: center; border-radius: 4px; background: var(--background-color); }
    .image-preview img { max-height: 100%; max-width: 100%; }

    @media (max-width: 768px){ .grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header>
  <nav class="container">
    <div class="logo"><i class="fas fa-box"></i> Fleet Manager â€¢ Packages</div>
    <div class="nav-links">
      <a href="/fleet-manager/dashboard"><i class="fas fa-arrow-left"></i> Back</a>
      <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  </nav>
</header>

<main class="container">
  <div id="flash" style="margin:10px 0;"></div>
  <div class="page-header">
    <h2><i class="fas fa-box"></i> Packages</h2>
    <div>
      <button class="btn btn-accent" onclick="openPackageModal()"><i class="fas fa-plus"></i> New Package</button>
    </div>
  </div>

  <div class="card">
    <table>
      <thead>
      <tr>
        <th>Image</th>
        <th>Name</th>
        <th>Price</th>
        <th>Duration (days)</th>
        <th>Status</th>
        <th>Vehicles</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody id="packages-tbody">
      <tr><td colspan="7">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<!-- Modal -->
<div class="modal" id="pkg-modal">
  <div class="content">
    <div class="header">
      <h3 id="modal-title">New Package</h3>
      <button class="btn" onclick="closePackageModal()"><i class="fas fa-times"></i> Close</button>
    </div>
    <form id="pkg-form" onsubmit="savePackage(event)">
      <input type="hidden" id="pkg-id" />
      <div class="grid">
        <div>
          <div class="form-group">
            <label>Package Name</label>
            <input type="text" id="pkg-name" required />
          </div>
          <div class="form-group">
            <label>Price</label>
            <input type="number" step="0.01" min="0" id="pkg-price" required />
          </div>
          <div class="form-group">
            <label>Duration (days)</label>
            <input type="number" min="1" id="pkg-duration" required />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="pkg-status">
              <option value="Activated">Activated</option>
              <option value="Deactivated">Deactivated</option>
            </select>
          </div>
        </div>
        <div>
          <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="pkg-image" oninput="updatePreview()" placeholder="https://..." />
          </div>
          <div class="image-preview" id="img-preview"><i class="fas fa-image" style="color:#bbb; font-size:28px;"></i></div>
          <div class="form-group" style="margin-top:10px;">
            <label>Assign Vehicles</label>
            <div class="vehicle-list" id="vehicle-list">
              <!-- checkboxes injected here -->
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top: 14px;">
        <button type="button" class="btn" onclick="closePackageModal()">Cancel</button>
        <button type="submit" class="btn btn-accent"><i class="fas fa-save"></i> Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  const token = localStorage.getItem('token');
  const headers = token ? { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'} : { 'Content-Type': 'application/json' };

  let allVehicles = [];
  let packages = [];

  document.addEventListener('DOMContentLoaded', () => {
    // simple role gate (client-side)
    const userRole = localStorage.getItem('userRole') || '';
    if (!(userRole.includes('FLEET_MANAGER') || userRole.includes('FLEETMANAGER'))) {
      window.location.href = '/dashboard?message=' + encodeURIComponent('You do not have permission to access this page') + '&type=error';
      return;
    }

    Promise.all([fetch('/api/vehicles', { headers }), fetch('/api/fleet/packages', { headers })])
      .then(async ([vehRes, pkgRes]) => {
        if (!vehRes.ok) throw new Error('Failed to load vehicles');
        if (!pkgRes.ok) throw new Error('Failed to load packages');
        allVehicles = await vehRes.json();
        packages = await pkgRes.json();
        renderVehicleCheckboxes();
        renderPackages();
      })
      .catch(err => flash('Error loading data: ' + err.message, 'error'));
  });

  function flash(msg, type='info') {
    const el = document.getElementById('flash');
    const color = type==='error'? '#e74c3c' : (type==='success'?'#2ecc71':'#3498db');
    el.innerHTML = `<div style="padding:10px; border:1px solid ${color}33; background:${color}11; color:${color}; border-radius:6px;">${msg}</div>`;
    setTimeout(()=>{ el.innerHTML=''; }, 4000);
  }

  function renderVehicleCheckboxes(selectedIds = []) {
    const box = document.getElementById('vehicle-list');
    box.innerHTML = '';
    const set = new Set(selectedIds);
    allVehicles.forEach(v => {
      const id = v.vehicleId;
      const label = `${v.make || ''} ${v.model || ''} (${v.registrationNumber || ''})`;
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.gap = '8px';
      row.innerHTML = `<input type="checkbox" value="${id}" ${set.has(id)?'checked':''}/> <span>${label}</span>`;
      box.appendChild(row);
    });
  }

  function renderPackages() {
    const tbody = document.getElementById('packages-tbody');
    if (!packages || packages.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:16px;">No packages found.</td></tr>';
      return;
    }
    tbody.innerHTML = '';
    packages.forEach(p => {
      const tr = document.createElement('tr');
      const img = p.imageUrl ? `<img src="${p.imageUrl}" alt="img" style="height:42px; border-radius:4px;" onerror="this.style.display='none'"/>` : '<i class="fas fa-image" style="color:#bbb;"></i>';
      const count = p.vehicles ? p.vehicles.length : 0;
      const isActive = (p.status || 'Activated') === 'Activated';
      tr.innerHTML = `
        <td>${img}</td>
        <td>${p.packageName || ''}</td>
        <td>${formatCurrency(p.price)}</td>
        <td>${p.duration || ''}</td>
        <td><span class="status ${isActive?'active':'inactive'}">${isActive?'Activated':'Deactivated'}</span></td>
        <td>${count}</td>
        <td style="display:flex; gap:6px;">
          <button class="btn" onclick="editPackage(${p.packageId})"><i class="fas fa-edit"></i> Edit</button>
          <button class="btn ${isActive?'':'btn-accent'}" onclick="toggleStatus(${p.packageId}, ${isActive})">${isActive?'Deactivate':'Activate'}</button>
          <button class="btn btn-danger" onclick="deletePackage(${p.packageId})"><i class="fas fa-trash"></i></button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function formatCurrency(val){
    if (val == null) return '-';
    try { return 'Rs. ' + Number(val).toFixed(2); } catch { return val; }
  }

  function openPackageModal(){
    document.getElementById('modal-title').innerText = 'New Package';
    document.getElementById('pkg-id').value = '';
    document.getElementById('pkg-name').value = '';
    document.getElementById('pkg-price').value = '';
    document.getElementById('pkg-duration').value = '';
    document.getElementById('pkg-status').value = 'Activated';
    document.getElementById('pkg-image').value = '';
    updatePreview();
    renderVehicleCheckboxes([]);
    document.getElementById('pkg-modal').style.display = 'block';
  }

  function closePackageModal(){ document.getElementById('pkg-modal').style.display = 'none'; }

  function updatePreview(){
    const url = document.getElementById('pkg-image').value;
    const holder = document.getElementById('img-preview');
    if (url && isValidUrl(url)) {
      holder.innerHTML = `<img src="${url}" alt="preview" onerror="this.parentElement.innerHTML=''<i class=\'fas fa-image\' style=\'color:#bbb; font-size:28px;\'></i>'';">`;
    } else {
      holder.innerHTML = '<i class="fas fa-image" style="color:#bbb; font-size:28px;"></i>';
    }
  }
  function isValidUrl(str){ try { new URL(str); return true; } catch { return false; } }

  function collectSelectedVehicleIds(){
    const box = document.getElementById('vehicle-list');
    const ids = [];
    box.querySelectorAll('input[type=checkbox]').forEach(cb => { if (cb.checked) ids.push(parseInt(cb.value)); });
    return ids;
  }

  async function savePackage(e){
    e.preventDefault();
    const id = document.getElementById('pkg-id').value;
    const body = {
      packageName: document.getElementById('pkg-name').value.trim(),
      price: parseFloat(document.getElementById('pkg-price').value),
      duration: parseInt(document.getElementById('pkg-duration').value),
      imageUrl: document.getElementById('pkg-image').value || null,
      status: document.getElementById('pkg-status').value,
      vehicleIds: collectSelectedVehicleIds()
    };
    if (!body.packageName || !isFinite(body.price) || !isFinite(body.duration)){
      flash('Please fill all required fields correctly', 'error'); return;
    }

    const method = id ? 'PUT' : 'POST';
    const url = id ? `/api/fleet/packages/${id}` : '/api/fleet/packages';
    try{
      const res = await fetch(url, { method, headers, body: JSON.stringify(body) });
      if (!res.ok) throw new Error(await res.text());
      const saved = await res.json();
      // refresh list
      await reloadPackages();
      closePackageModal();
      flash('Package saved successfully', 'success');
    }catch(err){
      flash('Failed to save package: ' + (err.message || err), 'error');
    }
  }

  async function editPackage(id){
    try{
      const res = await fetch(`/api/fleet/packages/${id}`, { headers });
      if (!res.ok) throw new Error('Failed to load package');
      const p = await res.json();
      document.getElementById('modal-title').innerText = 'Edit Package';
      document.getElementById('pkg-id').value = p.packageId;
      document.getElementById('pkg-name').value = p.packageName || '';
      document.getElementById('pkg-price').value = p.price || '';
      document.getElementById('pkg-duration').value = p.duration || '';
      document.getElementById('pkg-status').value = p.status || 'Activated';
      document.getElementById('pkg-image').value = p.imageUrl || '';
      updatePreview();
      const selected = (p.vehicles || []).map(v => v.vehicleId);
      renderVehicleCheckboxes(selected);
      document.getElementById('pkg-modal').style.display = 'block';
    }catch(err){ flash('Failed to load package: ' + err.message, 'error'); }
  }

  async function toggleStatus(id, currentlyActive){
    const next = currentlyActive ? 'Deactivated' : 'Activated';
    try{
      const res = await fetch(`/api/fleet/packages/${id}/status`, { method: 'PATCH', headers, body: JSON.stringify({ status: next })});
      if (!res.ok) throw new Error(await res.text());
      await reloadPackages();
      flash(`Package ${next.toLowerCase()} successfully`, 'success');
    }catch(err){ flash('Failed to change status: ' + (err.message||err), 'error'); }
  }

  async function deletePackage(id){
    if(!confirm('Delete this package?')) return;
    try{
      const res = await fetch(`/api/fleet/packages/${id}`, { method: 'DELETE', headers });
      if (res.status !== 204) throw new Error(await res.text());
      await reloadPackages();
      flash('Package deleted', 'success');
    }catch(err){ flash('Failed to delete: ' + (err.message||err), 'error'); }
  }

  async function reloadPackages(){
    const res = await fetch('/api/fleet/packages', { headers });
    if (res.ok){ packages = await res.json(); renderPackages(); }
  }
</script>
</body>
</html>

