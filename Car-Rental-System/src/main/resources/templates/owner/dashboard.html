<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Owner Dashboard | VeloRent</title>
  <link
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
          rel="stylesheet"
  />
  <script src="/js/jQuery/jquery-3.7.1.min.js"></script>

  <!--    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.css" />-->
  <!--    <script src="/css/bootstrap/js/bootstrap.js"></script>-->
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/css/fontawesome/css/all.css" />
  <!-- Luxury Theme CSS (Main styling) -->
  <link rel="stylesheet" href="/css/luxury-theme.css" />

  <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.min.css" />
  <script src="/js/jQuery/jquery-3.7.1.min.js"></script>
  <script src="/css/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <style>
    /* Admin Offer Dashboard Luxury Theme Overrides */
    .dt-search{
      display: flex ;
      justify-content: end;
      padding-bottom: 10px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font-luxury-secondary);
    }

    body {
      background: var(--luxury-black) !important;
      color: var(--text-luxury-light) !important;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: var(--luxury-charcoal);
      color: var(--text-luxury-light);
      padding: 1rem;
      box-shadow: var(--shadow-luxury);
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Keep the header on one line and prevent wrapping */
    .navbar-luxury .navbar-collapse { flex-wrap: nowrap; }
    .navbar-luxury .navbar-nav { flex-wrap: nowrap; align-items: center; }
    .navbar-luxury .navbar-nav.mr-auto { flex: 1 1 auto; overflow: hidden; white-space: nowrap; }
    .navbar-luxury .navbar-nav.mr-auto > li { white-space: nowrap; }
    .navbar-brand-luxury { white-space: nowrap; margin-right: 16px; }

    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--luxury-gold);
      font-family: var(--font-luxury-primary);
    }

    .nav-links {
      display: flex;
      gap: 20px;
    }

    .nav-links a {
      color: var(--text-luxury-light);
      text-decoration: none;
      padding: 10px 18px;
      border-radius: var(--radius-luxury-small);
      transition: var(--transition-smooth);
      font-weight: 500;
      border: 1px solid transparent;
    }

    .nav-links a:hover {
      background: var(--luxury-gold);
      color: var(--luxury-black);
      border-color: var(--luxury-gold);
      transform: translateY(-1px);
    }

    main {
      margin-top: 30px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px 0;
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }

    .dashboard-title {
      font-size: 28px;
      color: var(--luxury-gold);
      font-family: var(--font-luxury-primary);
      font-weight: 700;
      display: flex;
      align-items: center;
    }
    
    .dashboard-title::before {
      content: '\f02b';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      margin-right: 15px;
      color: var(--luxury-gold);
      font-size: 1.2em;
    }

    .dashboard-actions {
      display: flex;
      gap: 10px;
    }


    .chartTit{
      display: flex;
      justify-content: center;
      color: black;
    }

    /* Owner KPI cards (premium look) */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 24px;
      margin-top: 8px;
      margin-bottom: 28px;
    }
    .kpi-card {
      position: relative;
      padding: 22px 22px 18px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(212,175,55,0.28);
      box-shadow: 0 8px 26px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.02);
      backdrop-filter: blur(4px);
      transition: transform .2s ease, box-shadow .2s ease;
      overflow: hidden;
    }
    .kpi-card:before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: 14px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(212,175,55,0.55), rgba(255,255,255,0.04));
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      pointer-events: none;
    }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(0,0,0,0.45); }
    .kpi-icon {
      width: 42px; height: 42px; border-radius: 50%; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at 30% 30%, rgba(212,175,55,0.8), rgba(212,175,55,0.25));
      color: #0b0b0b; box-shadow: inset 0 0 10px rgba(0,0,0,0.25);
    }
    .kpi-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .kpi-title { font-weight:700; letter-spacing:.4px; color: var(--luxury-gold); }
    .kpi-value { font-size: 28px; font-weight: 800; color: #ffffff; margin: 2px 0 6px; }
    .kpi-sub { font-size:12px; color: rgba(255,255,255,0.75); text-transform: uppercase; letter-spacing:.6px; }
    .kpi-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; margin-top:8px; }
    .kpi-chip.gold { background: rgba(212,175,55,0.15); color: #f2d16b; border:1px solid rgba(212,175,55,0.35); }
    .kpi-chip.teal { background: rgba(22,160,133,0.15); color: #55d6c2; border:1px solid rgba(22,160,133,0.35); }
    .kpi-chip.navy { background: rgba(11,61,145,0.15); color: #7fb2ff; border:1px solid rgba(11,61,145,0.35); }
  </style>
</head>
<body>
<!-- Page Loader -->
<div class="page-loader">
  <div class="loader-content">
    <div class="loader-spinner"></div>
    <div class="loader-text">VeloRent Admin</div>
  </div>
</div>

<header>
  <nav class="navbar navbar-expand-lg navbar-luxury fixed-top">
    <div class="container">
      <a class="navbar-brand-luxury" href="/owner/dashboard"><i class="fas fa-crown mr-2"></i> VeloRent Admin</a>
      <div class="collapse navbar-collapse" id="navbarOwner">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item"><a class="nav-link-luxury" href="/owner/dashboard"><i class="fas fa-tachometer-alt mr-1"></i>Dashboard</a></li>
          <li class="nav-item"><a class="nav-link-luxury" href="/admin/feedback?from=owner"><i class="fas fa-comments mr-1"></i>Feedback</a></li>
          <li class="nav-item"><a class="nav-link-luxury" href="/admin/payments"><i class="fas fa-credit-card mr-1"></i>Payments</a></li>
          <li class="nav-item"><a class="nav-link-luxury" href="/admin/offers"><i class="fas fa-tags mr-1"></i>Offers</a></li>
          <li class="nav-item"><a class="nav-link-luxury" href="/fleet-manager/bookings"><i class="fas fa-calendar-check mr-1"></i>Bookings</a></li>
          <li class="nav-item"><a class="nav-link-luxury" id="owner-logout-link" href="/logout"><i class="fas fa-sign-out-alt mr-1"></i>Logout</a></li>
        </ul>
        <ul class="navbar-nav" style="align-items:center; gap: 8px;">
          <li class="nav-item notifications-wrapper" style="margin-right:12px;">
            <div class="dropdown" id="owner-notif">
              <button class="btn-luxury btn-luxury-outline" id="owner-notif-btn" title="Notifications" style="position:relative;margin-left:8px;display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;overflow:visible;">
                <i class="fas fa-bell"></i>
                <span id="owner-notif-badge" style="display:none;position:absolute;top:-6px;right:-6px;background:var(--luxury-gold);color:#000;border-radius:999px;font-size:11px;padding:1px 6px;font-weight:800;z-index:2;">0</span>
              </button>
              <div id="owner-notif-menu" class="dropdown-menu dropdown-menu-right" style="display:none;background: var(--luxury-dark); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: var(--radius-luxury); min-width: 360px; max-height:420px; overflow:auto; position:absolute; right:0;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:.6rem 1rem;border-bottom:1px solid rgba(212,175,55,.06)"><div style="font-weight:700;color:var(--luxury-gold)">Notifications</div><button id="owner-notif-mark" class="btn btn-secondary" style="padding:4px 8px; font-size:.8rem">Mark all read</button></div>
                <div id="owner-notif-list" style="padding:.5rem 0"></div>
              </div>
            </div>
          </li>
          <li class="nav-item">
            <div class="dropdown">
              <button class="btn-luxury btn-luxury-outline dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false" title="Account" style="margin-left: 8px;">
                <span id="owner-user-initials">OW</span>
              </button>
              <div class="dropdown-menu dropdown-menu-right" style="background: var(--luxury-dark); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: var(--radius-luxury); min-width: 240px;">
                <div class="dropdown-item-text" style="color: var(--luxury-gold); font-weight: 600; padding: 0.75rem 1rem; border-bottom: 1px solid rgba(212, 175, 55, 0.2);">
                  <div id="owner-user-name">Owner</div>
                  <small id="owner-user-email" style="color: var(--text-luxury-muted);">owner@velorent.com</small>
                </div>
                <a class="dropdown-item" href="/profile" id="owner-profile-dropdown-link" style="color: var(--text-luxury-light); padding: 0.75rem 1rem; transition: var(--transition-smooth); text-decoration: none;">
                  <i class="fas fa-user-circle mr-2"></i> Profile
                </a>
              </div>
            </div>
          </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>

<main class="container content" style="padding-top: 180px;">
  <div class="dashboard-header">
    <h1 class="dashboard-title">Owner Dashboard</h1>
    <div class="dashboard-actions">
      <a href="/admin/dashboard" class="btn btn-primary btn-back">Admin Dashboard</a>
      <a href="/fleet-manager/dashboard" class="btn btn-primary btn-back">Fleet Manager Dashboard</a>
      <a href="/dashboard" class="btn btn-primary btn-back">Customer Dashboard</a>
    </div>
  </div>

  <div class="container">
    <h1 class="text-center mb-4" style="color: var(--luxury-gold); font-family: var(--font-luxury-primary);">Vehicle Rental Dashboard</h1>

    <!-- Stats Cards (Luxury style to match Fleet) -->
    <div class="dashboard-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 40px;">
      <div class="luxury-card stat-card">
        <h3 class="card-title"><i class="fas fa-users mr-2"></i>Customers</h3>
        <div class="stat-number" id="owner-customers" th:text="${data.customerCount}">0</div>
      </div>
      <div class="luxury-card stat-card">
        <h3 class="card-title"><i class="fas fa-car mr-2"></i>Total Vehicles</h3>
        <div class="stat-number" id="owner-total" th:text="${data.vehicleCount}">0</div>
        <div class="stat-label">In Fleet</div>
      </div>
      <div class="luxury-card stat-card">
        <h3 class="card-title"><i class="fas fa-key mr-2"></i>In Use</h3>
        <div class="stat-number" id="owner-inuse" th:text="${data.inUseVehicleCount}">0</div>
        <div class="stat-label">Booked or Rented</div>
      </div>
      <div class="luxury-card stat-card">
        <h3 class="card-title"><i class="fas fa-check-circle mr-2"></i>Available</h3>
        <div class="stat-number" id="owner-available" th:text="${data.freeVehicleCount}">0</div>
        <div class="stat-label">Ready to Rent</div>
      </div>
    </div>

    <!-- Totals Row (All Time) -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon"><i class="fas fa-car"></i></div>
          <div class="kpi-title">Total Vehicle Rental Income</div>
        </div>
        <div class="kpi-value" id="total-vehicle-income">LKR 0.00</div>
        <div class="kpi-sub">All time</div>
        <div class="kpi-chip navy" id="vehicle-last7">Last 7 days: LKR 0.00</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon"><i class="fas fa-box"></i></div>
          <div class="kpi-title">Total Package Income</div>
        </div>
        <div class="kpi-value" id="total-package-income">LKR 0.00</div>
        <div class="kpi-sub">All time</div>
        <div class="kpi-chip gold" id="package-last7">Last 7 days: LKR 0.00</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon"><i class="fas fa-tools"></i></div>
          <div class="kpi-title">Total Maintenance Cost</div>
        </div>
        <div class="kpi-value" id="total-maintenance-cost">LKR 0.00</div>
        <div class="kpi-sub">All time</div>
        <div class="kpi-chip teal" id="maintenance-last7">Last 7 days: LKR 0.00</div>
      </div>
    </div>

    <!-- Financial Overview: Last 30 Days Trend Line Chart -->
    <div class="luxury-card" style="padding: 22px; margin-top: 6px;">
      <h3 class="card-title">Financial Trend (Last 30 Days)</h3>
      <p class="mb-2" style="opacity:.85">Income (Vehicle + Packages) vs Maintenance Cost</p>
      <canvas id="monthlyTrendChart"></canvas>
    </div>
  </div>




</main>
<script th:inline="javascript">
  // Logout function
  function handleLogout(e) {
    e.preventDefault();
    localStorage.clear();
    window.location.href = "/login?message=" + encodeURIComponent("You have been logged out") + "&type=success";
  }

  (function(){
    if(! localStorage.getItem("userRole") || !localStorage.getItem("userRole").includes("OWNER")){
      window.location.href = "/dashboard" ;
      return;
    }

    const fallbackData = /*[[${data}]]*/ {};

    function buildLast7DayLabels(){
      // Build labels using LOCAL time to match server-side LocalDate strings (YYYY-MM-DD)
      const pad = (n) => (n < 10 ? '0' + n : '' + n);
      const toYMD = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const labels=[]; const today = new Date();
      for (let i=6;i>=0;i--){ const d=new Date(today); d.setDate(d.getDate()-i); labels.push(toYMD(d)); }
      return labels;
    }

    function renderStats(d){
      document.getElementById('owner-customers').textContent = d.customerCount || 0;
      document.getElementById('owner-total').textContent = d.vehicleCount || 0;
      document.getElementById('owner-inuse').textContent = d.inUseVehicleCount || 0;
      document.getElementById('owner-available').textContent = d.freeVehicleCount || 0;
    }

    function renderCharts(d){
      // No charts now; show formatted totals (all time)
      const currency = new Intl.NumberFormat('en-LK', { style: 'currency', currency: 'LKR', maximumFractionDigits: 2 });
      const safe = (v)=> Number.isFinite(Number(v)) ? Number(v) : 0;

      function animateValue(el, end){
        const duration = 900; // ms
        const start = 0;
        const startTime = performance.now();
        function tick(now){
          const p = Math.min(1, (now - startTime)/duration);
          const val = start + (end - start)*p;
          el.textContent = currency.format(val);
          if (p < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      }

      animateValue(document.getElementById('total-vehicle-income'), safe(d.totalVehicleIncome));
      animateValue(document.getElementById('total-package-income'), safe(d.totalPackageIncome));
      animateValue(document.getElementById('total-maintenance-cost'), safe(d.totalMaintenanceCost));

      // Fill small chips with last-7-day context
      const labels = buildLast7DayLabels();
      const income = Array.isArray(d.incomeData) ? d.incomeData : [];
      const maintenance = Array.isArray(d.maintenanceData) ? d.maintenanceData : [];
      const findByDay = (arr, day) => arr.find(x => (x?.day ?? x?.date ?? x?.DAY) === day) || {};
      const last7Vehicle = labels.reduce((s, day)=> s + safe(findByDay(income, day).vehicleIncome), 0);
      const last7Package = labels.reduce((s, day)=> s + safe(findByDay(income, day).packageIncome), 0);
      const last7Maint = labels.reduce((s, day)=> s + safe((findByDay(maintenance, day).total ?? findByDay(maintenance, day).cost)), 0);
      document.getElementById('vehicle-last7').textContent = `Last 7 days: ${currency.format(last7Vehicle)}`;
      document.getElementById('package-last7').textContent = `Last 7 days: ${currency.format(last7Package)}`;
      document.getElementById('maintenance-last7').textContent = `Last 7 days: ${currency.format(last7Maint)}`;
    }

    fetch('/api/owner/dashboardData')
      .then(r => r.ok ? r.json() : fallbackData)
      .then(d => { 
        console.log('Dashboard data received:', d); 
        renderStats(d); 
        renderCharts(d);
  renderTotalsChart(d);
  renderMonthlyTrend(d);
      })
      .catch(err => { 
        console.error('Error fetching dashboard data:', err); 
        renderStats(fallbackData); 
        renderCharts(fallbackData); 
      });
  })();

  function renderTotalsChart(d){
    const ctx = document.getElementById('totalsChart');
    if(!ctx) return;
    const safe = (v)=> Number.isFinite(Number(v)) ? Number(v) : 0;
    const currency = new Intl.NumberFormat('en-LK', { style: 'currency', currency: 'LKR', maximumFractionDigits: 2 });
    const vehicle = safe(d.totalVehicleIncome);
    const pack = safe(d.totalPackageIncome);
    const incomeTotal = vehicle + pack;
    const maintenanceTotal = safe(d.totalMaintenanceCost);

    new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['Total Income', 'Maintenance Cost'],
        datasets: [{
          label: 'All-time totals',
          data: [incomeTotal, maintenanceTotal],
          backgroundColor: [
            'rgba(212,175,55,0.8)',
            'rgba(22,160,133,0.8)'
          ],
          borderColor: [
            '#d4af37',
            '#16a085'
          ],
          borderWidth: 1.5,
          borderRadius: 6,
          maxBarThickness: 68
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 10 },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx){
                const val = ctx.parsed.y ?? ctx.parsed ?? 0;
                return `${ctx.label}: ${currency.format(val)}`;
              }
            }
          }
        },
        scales: {
          x: { ticks: { color: '#e8e8e8' }, grid: { color: 'rgba(255,255,255,0.06)' } },
          y: {
            beginAtZero: true,
            ticks: {
              color: '#e8e8e8',
              callback: (v)=> currency.format(v)
            },
            grid: { color: 'rgba(255,255,255,0.06)' }
          }
        }
      }
    });
  }

  function renderMonthlyTrend(d){
    const ctx = document.getElementById('monthlyTrendChart');
    if(!ctx) return;
    const currency = new Intl.NumberFormat('en-LK', { style: 'currency', currency: 'LKR', maximumFractionDigits: 0 });
    // Use last 30 daily points already delivered as incomeData (total) and maintenanceData(total)
    const labels = (Array.isArray(d.incomeData) ? d.incomeData : []).map(x => x.day);
    const incomeData = labels.map(day => {
      const r = (d.incomeData||[]).find(x=>x.day===day);
      return (r?.total) ?? (Number(r?.vehicleIncome||0)+Number(r?.packageIncome||0));
    })
    const maintData = labels.map(day => (d.maintenanceData||[]).find(x=>x.day===day)?.total ?? 0);

    new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Income',
            data: incomeData,
            borderColor: '#0b3d91',
            backgroundColor: 'rgba(11,61,145,0.08)',
            tension: 0.35,
            pointRadius: 0,
            borderWidth: 3
          },
          {
            label: 'Maintenance',
            data: maintData,
            borderColor: '#16a085',
            backgroundColor: 'rgba(22,160,133,0.08)',
            tension: 0.35,
            pointRadius: 0,
            borderWidth: 3
          }
        ]
      },
      options: {
        responsive: true,
        layout: { padding: 10 },
        plugins: {
          legend: { labels: { color: '#f1f1f1' } },
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${currency.format(ctx.parsed.y||0)}` } }
        },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color:'#dcdcdc', callback: (v, i) => labels[i].slice(5) } },
          y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color:'#dcdcdc', callback:(v)=> currency.format(v) } }
        }
      }
    });
  }
</script>

<!-- Owner notifications (bell dropdown) -->
<script>
  (function(){
    const btn = document.getElementById('owner-notif-btn');
    const menu = document.getElementById('owner-notif-menu');
    const list = document.getElementById('owner-notif-list');
    const badge = document.getElementById('owner-notif-badge');
    const markBtn = document.getElementById('owner-notif-mark');
    if(!btn || !menu || !list || !badge) return;

    // local state
    let currentNotifs = [];

    function toggleMenu(){ menu.style.display = (menu.style.display === 'none' || menu.style.display==='') ? 'block':'none'; }
    btn.addEventListener('click', toggleMenu);
    document.addEventListener('click', (e)=>{ if(!e.target.closest('#owner-notif')) menu.style.display='none'; });

    function getRead(){ try { return new Set(JSON.parse(localStorage.getItem('ownerNotifRead')||'[]')); } catch(_) { return new Set(); } }
    function saveRead(s){ localStorage.setItem('ownerNotifRead', JSON.stringify(Array.from(s))); }
    function getPinned(){ try { return new Set(JSON.parse(localStorage.getItem('ownerNotifPinned')||'[]')); } catch(_) { return new Set(); } }
    function savePinned(s){ localStorage.setItem('ownerNotifPinned', JSON.stringify(Array.from(s))); }

    function stableId(n){
      if(n.id) return String(n.id);
      if(n.bookingId) return `bk_${n.bookingId}_${n.type||''}`;
      if(n.vehicleId) return `veh_${n.vehicleId}_${n.type||''}`;
      if(n.userId || n.customerId) return `usr_${n.userId||n.customerId}_${n.type||''}`;
      const raw = [n.type||'', n.title||'', n.message||'', n.icon||''].join('|');
      let h = 0; for(let i=0;i<raw.length;i++){ h=((h<<5)-h)+raw.charCodeAt(i); h|=0; }
      return `h_${Math.abs(h).toString(16)}`;
    }

    function iconColor(n){
      const t = (n.type||'').toLowerCase();
      if(t.includes('booking') && t.includes('confirm')) return '#4caf50';
      if(t.includes('booking') && (t.includes('cancel')||t.includes('reject'))) return '#f44336';
      if(t.includes('countdown') || t.includes('soon')) return '#ffc107';
      if(t.includes('maintenance') || t.includes('service')) return '#ff9800';
      if(t.includes('vehicle')) return '#9c27b0';
      if(t.includes('payment')) return '#00bcd4';
      if(t.includes('user') || t.includes('register')) return '#2196f3';
      if(t.includes('feedback')) return '#ffb300';
      const ic = (n.icon||'');
      if(ic.includes('credit-card')) return '#00bcd4';
      if(ic.includes('user')) return '#2196f3';
      if(ic.includes('car')) return '#9c27b0';
      if(ic.includes('comments')) return '#ffb300';
      if(ic.includes('times')) return '#f44336';
      if(ic.includes('check')) return '#4caf50';
      if(ic.includes('hourglass')) return '#ffc107';
      if(ic.includes('tools')) return '#ff9800';
      return 'var(--luxury-gold)';
    }

    function iconHtml(n){
      const color = iconColor(n);
      return `<i class="fas ${n.icon||'fa-bell'}" style="width:18px;text-align:center;color:${color};filter: drop-shadow(0 0 2px ${color}55);"></i>`;
    }

    function updateBadge(unread){
      if(unread>0){ badge.style.display='inline-block'; badge.textContent = unread; }
      else { badge.style.display='none'; badge.textContent = '0'; }
    }

    function isPayment(n){
      const t=(n.type||'').toLowerCase();
      const title=(n.title||'').toLowerCase();
      const msg=(n.message||'').toLowerCase();
      const icon=(n.icon||'').toLowerCase();
      return t.includes('payment') || title.includes('payment') || msg.includes('payment') || icon.includes('credit-card');
    }

    function isNewAdmin(n){
      const t=(n.type||'').toLowerCase();
      const title=(n.title||'').toLowerCase();
      const msg=(n.message||'').toLowerCase();
      const role=(n.role||n.userRole||'').toString().toUpperCase();
      // Consider only registration/creation events, never login
      const isRegistration = t.includes('register') || title.includes('registered') || msg.includes('registered') || title.includes('new user') || msg.includes('new user');
      const mentionsAdmin = role==='ADMIN' || title.includes('admin') || msg.includes('admin');
      return isRegistration && mentionsAdmin;
    }

    function isFeedback(n){
      const t=(n.type||'').toLowerCase();
      const title=(n.title||'').toLowerCase();
      const msg=(n.message||'').toLowerCase();
      const icon=(n.icon||'').toLowerCase();
      return t.includes('feedback') || title.includes('feedback') || msg.includes('feedback') || icon.includes('comments');
    }

    function isOwnerAllowed(n){
      return isFeedback(n) || isNewAdmin(n) || isPayment(n);
    }

    function getDeleted(){ try { return new Set(JSON.parse(localStorage.getItem('ownerNotifDeleted')||'[]')); } catch(_) { return new Set(); } }
    function saveDeleted(s){ localStorage.setItem('ownerNotifDeleted', JSON.stringify(Array.from(s))); }

    function render(notifs){
      list.innerHTML = '';
      const read = getRead();
      const pinned = getPinned();
      const deleted = getDeleted();
      let unread = 0;
      if(!Array.isArray(notifs) || notifs.length===0){
        list.innerHTML = '<div style="padding:.75rem 1rem;color:var(--text-luxury-muted)">No notifications</div>';
        updateBadge(0);
        return;
      }
      const pinnedItems = [];
      const otherItems = [];
      notifs.forEach(n=>{
        const id = stableId(n);
        if(id && deleted.has(id)) return; // skip deleted
        const isRead = id && read.has(id);
        if(!isRead) unread++;
        const entry = { n, id, isRead };
        if(id && pinned.has(id)) pinnedItems.push(entry); else otherItems.push(entry);
      });

      if(pinnedItems.length>0){
        const hdr = document.createElement('div');
        hdr.style.cssText = 'padding:.4rem 1rem;color:var(--luxury-gold);font-weight:700;border-bottom:1px solid rgba(212,175,55,.2)';
        hdr.textContent = 'Pinned';
        list.appendChild(hdr);
      }

      function appendRow(entry){
        const { n, id, isRead } = entry;
        const isPinned = id && pinned.has(id);
        const time = n.timestamp ? new Date(n.timestamp).toLocaleString() : '';
        const div = document.createElement('div');
        div.style.cssText = 'display:flex;gap:10px;align-items:flex-start;padding:.6rem 1rem;border-bottom:1px solid rgba(212,175,55,.1)';
        const pinColor = isPinned ? 'var(--luxury-gold)' : '#aaa';
        const actions = isPayment(n) ? `<div style=\"margin-top:6px\"><a href=\"/admin/payments?from=owner\" class=\"btn btn-secondary btn-sm\" style=\"padding:4px 10px;border-radius:8px;\">View details</a></div>` : '';
        div.innerHTML = `${iconHtml(n)}<div style=\"flex:1\"><div style=\"font-weight:700;color:var(--luxury-gold)\">${n.title||'Notification'}${isPinned?' <span style=\\"font-size:.75rem;color:var(--luxury-gold)\\">(pinned)</span>':''}</div><div style=\"color:var(--text-luxury-light);font-size:.92rem;margin-top:2px\">${n.message||''}</div>${actions}<div style=\"color:var(--text-luxury-muted);font-size:.8rem;margin-top:4px\">${time}</div></div><span class=\"pin\" data-id=\"${id}\" title=\"${isPinned?'Unpin':'Pin'}\" style=\"color:${pinColor};margin-right:10px\"><i class=\"fas fa-thumbtack\"></i></span><span class=\"tick\" data-id=\"${id}\" title=\"Mark as read\" style=\"color:${isRead?'#4caf50':'#aaa'};margin-right:10px\"><i class=\"fas fa-check\"></i></span><span class=\"del\" data-id=\"${id}\" title=\"Delete\" style=\"color:#c0392b\"><i class=\"fas fa-trash\"></i></span>`;
        list.appendChild(div);
      }

      pinnedItems.forEach(appendRow);
      if(pinnedItems.length>0 && otherItems.length>0){
        const sep = document.createElement('div');
        sep.style.cssText = 'padding:.2rem 1rem;color:var(--text-luxury-muted);font-size:.8rem;border-bottom:1px solid rgba(212,175,55,.1)';
        sep.textContent = 'All notifications';
        list.appendChild(sep);
      }
      otherItems.forEach(appendRow);

      updateBadge(unread);
    }

    async function load(){
      try{
        // Reuse admin notifications for owner view
        const res = await fetch('/api/admin/notifications', { headers: { 'Accept': 'application/json' }});
        const data = await res.json();
        let arr = Array.isArray(data)?data:[];
        // Filter allowed owner notifications and sort newest first when timestamps exist
        arr = arr.filter(isOwnerAllowed);
        arr.sort((a,b)=>{
          const ta = a.timestamp ? new Date(a.timestamp).getTime() : 0;
          const tb = b.timestamp ? new Date(b.timestamp).getTime() : 0;
          return tb - ta;
        });
        currentNotifs = arr;
        render(currentNotifs);
      }catch(e){ console.error('Owner notifications failed', e); }
    }

    list.addEventListener('click', (e)=>{
      const t = e.target.closest('.tick');
      if(t){ const id = t.getAttribute('data-id'); if(!id) return; const s = getRead(); s.add(id); saveRead(s); return render(currentNotifs); }
      const p = e.target.closest('.pin');
      if(p){ const id = p.getAttribute('data-id'); if(!id) return; const sp = getPinned(); if(sp.has(id)) sp.delete(id); else sp.add(id); savePinned(sp); return render(currentNotifs); }
      const d = e.target.closest('.del');
      if(d){
        const id = d.getAttribute('data-id'); if(!id) return;
        const sd = getDeleted(); sd.add(id); saveDeleted(sd);
        // Optimistic remove from current list
        currentNotifs = currentNotifs.filter(n => stableId(n) !== id);
        return render(currentNotifs);
      }
    });

    markBtn && markBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const s = getRead();
      const ids = Array.from(list.querySelectorAll('.tick')).map(el => el.getAttribute('data-id')).filter(Boolean);
      ids.forEach(id => s.add(id));
      saveRead(s);
      render(currentNotifs);
    });

    load();
    setInterval(load, 30000);
  })();
</script>

<!-- Profile wiring: populate and link to Profile page -->
<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Intercept logout link and perform client-side logout to avoid server 404/whitelabel
    var logoutLink = document.getElementById('owner-logout-link');
    if (logoutLink) {
      logoutLink.addEventListener('click', handleLogout);
    }

    const userName = localStorage.getItem('userName') || 'Owner';
    const userEmail = localStorage.getItem('userEmail') || 'owner@velorent.com';

    const nameEl = document.getElementById('owner-user-name');
    const emailEl = document.getElementById('owner-user-email');
    if (nameEl) nameEl.textContent = userName;
    if (emailEl) emailEl.textContent = userEmail;

    const initials = userName.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
    const initialsEl = document.getElementById('owner-user-initials');
    if (initialsEl) {
      initialsEl.textContent = initials || 'OW';
      initialsEl.style.cursor = 'pointer';
      initialsEl.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        window.location.href = `/profile?email=${encodeURIComponent(userEmail)}`;
      });
    }

    const profileLink = document.getElementById('owner-profile-dropdown-link');
    if (profileLink) profileLink.href = `/profile?email=${encodeURIComponent(userEmail)}`;
  });
</script>

<!-- Luxury Theme JavaScript -->
<script src="/js/luxury-theme.js"></script>
<script src="/js/luxury-theme-enhancer.js"></script>

</body>
</html>
