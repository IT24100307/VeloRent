<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | Car Rental System</title>
  <link
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
          rel="stylesheet"
  />
  <script src="/js/jQuery/jquery-3.7.1.min.js"></script>

  <!--    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.css" />-->
  <!--    <script src="/css/bootstrap/js/bootstrap.js"></script>-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="/css/DataTables/datatables.css" />
  <script src="/css/DataTables/datatables.js"></script>

  <link rel="stylesheet" href="/css/bootstrap-datepicker/css/bootstrap-datepicker.min.css" />
  <script src="/css/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>

  <link rel="stylesheet" href="/css/fontawesome/css/all.css" />

  <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">-->
  <!--    &lt;!&ndash; DataTables CSS &ndash;&gt;-->
  <!--    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">-->
  <!--    &lt;!&ndash; DataTables Buttons CSS &ndash;&gt;-->
  <!--    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">-->
  <!--    &lt;!&ndash; Bootstrap Datepicker CSS &ndash;&gt;-->
  <!--    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">-->
  <!--    &lt;!&ndash; jQuery &ndash;&gt;-->
  <!--    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
  <!--    &lt;!&ndash; Bootstrap JS &ndash;&gt;-->
  <!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->
  <!--    &lt;!&ndash; DataTables JS &ndash;&gt;-->
  <!--    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>-->
  <!--    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>-->
  <!-- DataTables Buttons JS -->
  <!--    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>-->
  <!--    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>-->
  <!--    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>-->
  <!--    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>-->
  <!-- Bootstrap Datepicker JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

  <style>
    :root {
      --primary-color: #1a237e;
      --secondary-color: #3498db;
      --accent-color: #2ecc71;
      --danger-color: #e74c3c;
      --text-color: #333;
      --light-text: #666;
      --background-color: #f8f9fa;
      --card-background: #fff;
      --border-color: #e1e1e1;
    }
    .dt-search{
      display: flex ;
      justify-content: end;
      padding-bottom: 10px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Roboto", "Segoe UI", Arial, sans-serif;
    }

    body {
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background-color: var(--primary-color);
      color: white;
      padding: 1rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .nav-links {
      display: flex;
      gap: 20px;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .nav-links a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    main {
      margin-top: 30px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .dashboard-title {
      font-size: 24px;
      color: var(--primary-color);
    }

    .dashboard-actions {
      display: flex;
      gap: 10px;
    }




    .customer-list table {
      width: 100%;
      border-collapse: collapse;
    }

    .customer-list th,
    .customer-list td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .customer-list th {
      background-color: #f1f5f9;
      font-weight: 500;
    }

    .customer-list tr:hover {
      background-color: #f9f9f9;
      cursor: pointer;
    }


    .btn-back {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      text-decoration: none;
      display: inline-block;
    }




  </style>
</head>
<body>
<header>
  <nav class="container">
    <div class="logo">VeloRent Admin</div>
    <div class="nav-links">
      <a href="/admin/dashboard">Dashboard</a>
      <a href="#">Vehicles</a>
      <a href="/admin/offers">Offers</a>
      <a href="/admin/feedback">Feedback</a>
      <a href="#">Reports</a>
      <a href="/logout">Logout</a>
    </div>
  </nav>
</header>

<main class="container content">
  <div class="dashboard-header">
    <h1 class="dashboard-title">Offers Dashboard</h1>
    <div class="dashboard-actions">
      <a href="/dashboard" class="btn btn-primary btn-back">Back to Dashboard</a>
      <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#offerModal" onclick="resetModal()">Add Offer</a>
    </div>
  </div>
  <table id="offersTable" class="table table-striped" style="width:100%">
    <thead>
    <tr>
      <th>Name</th>
      <th>Discount (%)</th>
      <th>Start Date</th>
      <th>End Date</th>
      <th>Active</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <!-- DataTable will populate this -->
    </tbody>
  </table>

  <!-- Offer Modal -->
  <div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="offerModalLabel">Add Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="offerForm" novalidate>
            <div class="mb-3">
              <label for="offerName" class="form-label">Offer Name</label>
              <input type="text" class="form-control" id="offerName" required>
              <div class="invalid-feedback">Please enter an offer name.</div>
            </div>
            <div class="mb-3">
              <label for="discountAmount" class="form-label">Discount Percentage (%)</label>
              <input type="number" class="form-control" id="discountAmount" step="0.01" min="0" required>
              <div class="invalid-feedback">Please enter a valid discount percentage (integer or up to two decimal places).</div>
            </div>
            <div class="mb-3">
              <label for="startDate" class="form-label">Start Date</label>
              <input type="text" class="form-control datepicker" id="startDate" required>
              <div class="invalid-feedback" id="startDateFeedback">Please enter a valid start date.</div>
            </div>
            <div class="mb-3">
              <label for="endDate" class="form-label">End Date</label>
              <input type="text" class="form-control datepicker" id="endDate" required>
              <div class="invalid-feedback" id="endDateFeedback">Please enter a valid end date.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveOffer()">Add Offer</button>
        </div>
      </div>
    </div>
  </div>



</main>
<script>
  $(document).ready(function() {
    // Initialize Datepickers
    $('.datepicker').datepicker({
      format: 'yyyy-mm-dd',
      autoclose: true
    });

    // Initialize DataTable
    let table = $('#offersTable').DataTable({
      ajax: {
        url: '/api/admin/offer',
        dataSrc: ''
      },
      columns: [
        { data: 'name' },
        { data: 'discount' },
        { data: 'startDate' },
        { data: 'endDate' },
        {
          data: 'isActive',
          render: function(data) {
            return data ? 'Yes' : 'No';
          }
        },
        {
          data: null,
          render: function(data, type, row) {
            return `
                                <button class="btn btn-sm btn-primary" onclick="editOffer(${row.offerId})">Edit</button>
                                <button class="btn btn-sm btn-success" onclick="toggleActive(${row.offerId}, ${!row.isActive})">${row.isActive ? 'Deactivate' : 'Activate'}</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOffer(${row.offerId})">Delete</button>
                            `;
          }
        }
      ],
      dom: 'Bfrtip',
      language: {
        emptyTable: "No Offers Available"
      },
      buttons: [
        {
          extend: 'colvis',
          collectionLayout: 'fixed two-column'
        },
        'copyHtml5',
        'excelHtml5',
        'csvHtml5',
      ]
    });
  });

  function validateForm(isEditMode) {
    const form = document.getElementById('offerForm');
    const offerName = $('#offerName').val();
    const discount = $('#discountAmount').val();
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Normalize to start of day

    let isValid = true;
    form.classList.add('was-validated');

    // Validate offer name
    if (!offerName || offerName.trim() === '') {
      $('#offerName').addClass('is-invalid');
      isValid = false;
    } else {
      $('#offerName').removeClass('is-invalid');
    }

    // Validate discount (integer or up to two decimal places)
    const discountRegex = /^\d+(\.\d{1,2})?$/;
    if (!discount || !discountRegex.test(discount) || parseFloat(discount) <= 0) {
      $('#discountAmount').addClass('is-invalid');
      isValid = false;
    } else {
      $('#discountAmount').removeClass('is-invalid');
    }

    // Validate dates
    const startDateObj = new Date(startDate);
    const endDateObj = new Date(endDate);

    if (!startDate || isNaN(startDateObj)) {
      $('#startDate').addClass('is-invalid');
      $('#startDateFeedback').text('Please enter a valid start date.');
      isValid = false;
    } else if (!isEditMode && startDateObj <= today) {
      $('#startDate').addClass('is-invalid');
      $('#startDateFeedback').text('Start date must be after today.');
      isValid = false;
    } else {
      $('#startDate').removeClass('is-invalid');
    }

    if (!endDate || isNaN(endDateObj)) {
      $('#endDate').addClass('is-invalid');
      $('#endDateFeedback').text('Please enter a valid end date.');
      isValid = false;
    } else if (endDateObj <= today) {
      $('#endDate').addClass('is-invalid');
      $('#endDateFeedback').text('End date must be after today.');
      isValid = false;
    } else if (endDateObj <= startDateObj) {
      $('#endDate').addClass('is-invalid');
      $('#endDateFeedback').text('End date must be after start date.');
      isValid = false;
    } else {
      $('#endDate').removeClass('is-invalid');
    }

    return isValid;
  }

  function resetModal() {
    $('#offerModalLabel').text('Add Offer');
    $('#offerForm')[0].reset();
    $('#offerModal .modal-footer .btn-primary').text('Add Offer').attr('onclick', 'saveOffer()');
    $('#offerModal').removeData('id');
  }

  function getInt(val,errorVal){
    try{
      return Integer.parseInt(val);
    }catch (e){
      console.warn(e);
      return errorVal;
    }
  }

  function saveOffer() {
    const isEditMode = !!$('#offerModal').data('id');
    if (!validateForm(isEditMode)) {
      return;
    }
    const offer = {
      name: $('#offerName').val(),
      discount: $('#discountAmount').val(),
      startDate: $('#startDate').val(),
      endDate: $('#endDate').val()
    };

    const url = $('#offerModal').data('id') ? `/api/admin/offer/${$('#offerModal').data('id')}` : '/api/admin/offer';
    const method = $('#offerModal').data('id') ? 'PUT' : 'POST';

    $.ajax({
      url: url,
      type: method,
      contentType: 'application/json',
      data: JSON.stringify(offer),
      success: function() {
        $('#offersTable').DataTable().ajax.reload();
        $('#offerModal').modal('hide');
      },
      error: function() {
        alert('Error saving offer');
      }
    });
  }

  function editOffer(id) {
    $.get(`/api/admin/offer/${id}`, function(rowData) {
      $('#offerModalLabel').text('Edit Offer');
      $('#offerName').val(rowData.name);
      $('#discountAmount').val(rowData.discount);
      $('#startDate').val(rowData.startDate);
      $('#endDate').val(rowData.endDate);
      $('#offerModal').data('id', id);
      $('#offerModal .modal-footer .btn-primary').text('Update Offer').attr('onclick', 'saveOffer()');
      $('#offerModal').modal('show');
    });
  }

  function toggleActive(id, isActive) {
    $.ajax({
      url: `/api/admin/offer/${id}/active`,
      type: 'PATCH',
      contentType: 'application/json',
      data: JSON.stringify(isActive),
      success: function() {
        $('#offersTable').DataTable().ajax.reload();
      },
      error: function() {
        alert('Error toggling active status');
      }
    });
  }

  function deleteOffer(id) {
    if (confirm('Are you sure you want to delete this offer?')) {
      $.ajax({
        url: `/api/admin/offer/${id}`,
        type: 'DELETE',
        success: function() {
          $('#offersTable').DataTable().ajax.reload();
        },
        error: function() {
          alert('Error deleting offer');
        }
      });
    }
  }

  function refreshTable() {
    $('#offersTable').DataTable().ajax.reload();
  }
</script>

</body>
</html>
