<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | Car Rental System</title>
  <link
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
          rel="stylesheet"
  />
  <script src="/js/jQuery/jquery-3.7.1.min.js"></script>

  <!--    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.css" />-->
  <!--    <script src="/css/bootstrap/js/bootstrap.js"></script>-->
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/css/fontawesome/css/all.css" />
  <!-- Luxury Theme CSS (Main styling) -->
  <link rel="stylesheet" href="/css/luxury-theme.css" />
  <!-- Bootstrap CSS (Secondary for grid system) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="/css/DataTables/datatables.css" />
  <!-- Bootstrap Datepicker CSS -->
  <link rel="stylesheet" href="/css/bootstrap-datepicker/css/bootstrap-datepicker.min.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/css/DataTables/datatables.js"></script>
  <script src="/css/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>

  <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">-->
  <!--    &lt;!&ndash; DataTables CSS &ndash;&gt;-->
  <!--    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">-->
  <!--    &lt;!&ndash; DataTables Buttons CSS &ndash;&gt;-->
  <!--    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">-->
  <!--    &lt;!&ndash; Bootstrap Datepicker CSS &ndash;&gt;-->
  <!--    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">-->
  <!--    &lt;!&ndash; jQuery &ndash;&gt;-->
  <!--    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
  <!--    &lt;!&ndash; Bootstrap JS &ndash;&gt;-->
  <!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->
  <!--    &lt;!&ndash; DataTables JS &ndash;&gt;-->
  <!--    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>-->
  <!--    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>-->
  <!-- DataTables Buttons JS -->
  <!--    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>-->
  <!--    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>-->
  <!--    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>-->
  <!--    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>-->
  <!-- Bootstrap Datepicker JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

  <style>
    /* Admin Offer Dashboard Luxury Theme Overrides */
    .dt-search{
      display: flex ;
      justify-content: end;
      padding-bottom: 10px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font-luxury-secondary);
    }

    body {
      background: var(--luxury-black) !important;
      color: var(--text-luxury-light) !important;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: var(--luxury-charcoal);
      color: var(--text-luxury-light);
      padding: 1rem;
      box-shadow: var(--shadow-luxury);
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--luxury-gold);
      font-family: var(--font-luxury-primary);
    }

    .nav-links {
      display: flex;
      gap: 20px;
    }

    .nav-links a {
      color: var(--text-luxury-light);
      text-decoration: none;
      padding: 10px 18px;
      border-radius: var(--radius-luxury-small);
      transition: var(--transition-smooth);
      font-weight: 500;
      border: 1px solid transparent;
    }

    .nav-links a:hover {
      background: var(--luxury-gold);
      color: var(--luxury-black);
      border-color: var(--luxury-gold);
      transform: translateY(-1px);
    }

    main {
      margin-top: 30px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px 0;
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }

    .dashboard-title {
      font-size: 28px;
      color: var(--luxury-gold);
      font-family: var(--font-luxury-primary);
      font-weight: 700;
      display: flex;
      align-items: center;
    }
    
    .dashboard-title::before {
      content: '\f02b';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      margin-right: 15px;
      color: var(--luxury-gold);
      font-size: 1.2em;
    }

    .dashboard-actions {
      display: flex;
      gap: 10px;
    }




    /* Table Styling */
    #offersTable {
      background: var(--luxury-charcoal) !important;
      border-radius: var(--radius-luxury-large);
      overflow: hidden;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    #offersTable thead th {
      background: linear-gradient(135deg, var(--luxury-black) 0%, var(--luxury-charcoal) 100%) !important;
      color: var(--luxury-gold) !important;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3) !important;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
      padding: 15px !important;
    }
    
    #offersTable tbody td {
      background: var(--luxury-charcoal) !important;
      color: var(--text-luxury-light) !important;
      border-bottom: 1px solid rgba(212, 175, 55, 0.1) !important;
      padding: 15px !important;
    }
    
    #offersTable tbody tr:hover {
      background: rgba(212, 175, 55, 0.1) !important;
    }

    /* Button Styling */
    .btn, .btn-primary, .btn-success, .btn-secondary, .btn-danger {
      border-radius: var(--radius-luxury-small) !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
      transition: var(--transition-smooth) !important;
      border: none !important;
    }
    
    .btn-primary, .btn-back {
      background: var(--gradient-gold) !important;
      color: var(--luxury-black) !important;
    }
    
    .btn-primary:hover, .btn-back:hover {
      background: linear-gradient(135deg, #f4d03f 0%, #d4af37 100%) !important;
      transform: translateY(-2px) !important;
      box-shadow: var(--shadow-luxury) !important;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%) !important;
      color: white !important;
    }
    
    .btn-secondary {
      background: transparent !important;
      color: var(--luxury-gold) !important;
      border: 2px solid var(--luxury-gold) !important;
    }
    
    .btn-secondary:hover {
      background: var(--luxury-gold) !important;
      color: var(--luxury-black) !important;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
      color: white !important;
    }




    
    /* Modal Styling */
    .modal-content {
      background: var(--luxury-charcoal) !important;
      color: var(--text-luxury-light) !important;
      border: 1px solid rgba(212, 175, 55, 0.3) !important;
      border-radius: var(--radius-luxury-large) !important;
    }
    
    .modal-header {
      border-bottom: 1px solid rgba(212, 175, 55, 0.2) !important;
    }
    
    .modal-title {
      color: var(--luxury-gold) !important;
      font-family: var(--font-luxury-primary) !important;
    }
    
    .form-control, .form-select {
      background: var(--luxury-black) !important;
      color: var(--text-luxury-light) !important;
      border: 1px solid rgba(212, 175, 55, 0.3) !important;
      border-radius: var(--radius-luxury-small) !important;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--luxury-gold) !important;
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2) !important;
    }
    
    .form-label {
      color: var(--text-luxury-light) !important;
      font-weight: 600 !important;
    }
    
    /* DataTables Luxury Theme Overrides */
    .dataTables_wrapper {
      color: var(--text-luxury-light) !important;
    }
    
    .dataTables_filter input {
      background: var(--luxury-black) !important;
      color: var(--text-luxury-light) !important;
      border: 1px solid rgba(212, 175, 55, 0.3) !important;
      border-radius: var(--radius-luxury-small) !important;
      padding: 8px 12px !important;
    }
    
    .dataTables_length select {
      background: var(--luxury-black) !important;
      color: var(--text-luxury-light) !important;
      border: 1px solid rgba(212, 175, 55, 0.3) !important;
      border-radius: var(--radius-luxury-small) !important;
    }
    
    .dataTables_info {
      color: var(--text-luxury-muted) !important;
    }
    
    .paginate_button {
      background: var(--luxury-charcoal) !important;
      color: var(--text-luxury-light) !important;
      border: 1px solid rgba(212, 175, 55, 0.2) !important;
      border-radius: var(--radius-luxury-small) !important;
      margin: 0 2px !important;
    }
    
    .paginate_button:hover {
      background: var(--luxury-gold) !important;
      color: var(--luxury-black) !important;
    }
    
    .paginate_button.current {
      background: var(--luxury-gold) !important;
      color: var(--luxury-black) !important;
    }
  </style>
</head>
<body>
<!-- Page Loader -->
<div class="page-loader">
  <div class="loader-content">
    <div class="loader-spinner"></div>
    <div class="loader-text">VeloRent Admin</div>
  </div>
</div>

<header>
  <nav class="container">
    <div class="logo">
      <i class="fas fa-crown mr-2"></i>VeloRent Admin
    </div>
    <div class="nav-links">
      <a href="/admin/dashboard"><i class="fas fa-tachometer-alt mr-1"></i>Dashboard</a>
      <a href="#"><i class="fas fa-car mr-1"></i>Vehicles</a>
      <a href="/admin/offers"><i class="fas fa-tags mr-1"></i>Offers</a>
      <a href="/admin/feedback"><i class="fas fa-comments mr-1"></i>Feedback</a>
      <a href="#"><i class="fas fa-chart-bar mr-1"></i>Reports</a>
      <a href="/logout"><i class="fas fa-sign-out-alt mr-1"></i>Logout</a>
    </div>
  </nav>
</header>

<main class="container content">
  <div class="dashboard-header">
    <h1 class="dashboard-title">Offers Dashboard</h1>
    <div class="dashboard-actions">
      <a href="/dashboard" class="btn btn-primary btn-back">Back to Dashboard</a>
      <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#offerModal" onclick="resetModal()">Add Offer</a>
    </div>
  </div>
  <table id="offersTable" class="table table-striped" style="width:100%">
    <thead>
    <tr>
      <th>Name</th>
      <th>Discount (%)</th>
      <th>Start Date</th>
      <th>End Date</th>
      <th>Active</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <!-- DataTable will populate this -->
    </tbody>
  </table>

  <!-- Offer Modal -->
  <div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="offerModalLabel">Add Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="offerForm" novalidate>
            <div class="mb-3">
              <label for="offerName" class="form-label">Offer Name</label>
              <input type="text" class="form-control" id="offerName" required>
              <div class="invalid-feedback">Please enter an offer name.</div>
            </div>
            <div class="mb-3">
              <label for="discountAmount" class="form-label">Discount Percentage (%)</label>
              <input type="number" class="form-control" id="discountAmount" step="0.01" min="0" required>
              <div class="invalid-feedback">Please enter a valid discount percentage (integer or up to two decimal places).</div>
            </div>
            <div class="mb-3">
              <label for="startDate" class="form-label">Start Date</label>
              <input type="text" class="form-control datepicker" id="startDate" required>
              <div class="invalid-feedback" id="startDateFeedback">Please enter a valid start date.</div>
            </div>
            <div class="mb-3">
              <label for="endDate" class="form-label">End Date</label>
              <input type="text" class="form-control datepicker" id="endDate" required>
              <div class="invalid-feedback" id="endDateFeedback">Please enter a valid end date.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveOffer()">Add Offer</button>
        </div>
      </div>
    </div>
  </div>



</main>
<script>
  $(document).ready(function() {
    // Initialize Datepickers
    $('.datepicker').datepicker({
      format: 'yyyy-mm-dd',
      autoclose: true
    });

    // Initialize DataTable
    let table = $('#offersTable').DataTable({
      ajax: {
        url: '/api/admin/offer',
        dataSrc: ''
      },
      columns: [
        { data: 'name' },
        { data: 'discount' },
        { data: 'startDate' },
        { data: 'endDate' },
        {
          data: 'isActive',
          render: function(data) {
            return data ? 'Yes' : 'No';
          }
        },
        {
          data: null,
          render: function(data, type, row) {
            return `
                                <button class="btn btn-sm btn-primary" onclick="editOffer(${row.offerId})">Edit</button>
                                <button class="btn btn-sm btn-success" onclick="toggleActive(${row.offerId}, ${!row.isActive})">${row.isActive ? 'Deactivate' : 'Activate'}</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOffer(${row.offerId})">Delete</button>
                            `;
          }
        }
      ],
      dom: 'Bfrtip',
      language: {
        emptyTable: "No Offers Available"
      },
      buttons: [
        {
          extend: 'colvis',
          collectionLayout: 'fixed two-column'
        },
        'copyHtml5',
        'excelHtml5',
        'csvHtml5',
      ]
    });
  });

  function validateForm(isEditMode) {
    const form = document.getElementById('offerForm');
    const offerName = $('#offerName').val();
    const discount = $('#discountAmount').val();
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Normalize to start of day

    let isValid = true;
    form.classList.add('was-validated');

    // Validate offer name
    if (!offerName || offerName.trim() === '') {
      $('#offerName').addClass('is-invalid');
      isValid = false;
    } else {
      $('#offerName').removeClass('is-invalid');
    }

    // Validate discount (integer or up to two decimal places)
    const discountRegex = /^\d+(\.\d{1,2})?$/;
    if (!discount || !discountRegex.test(discount) || parseFloat(discount) <= 0) {
      $('#discountAmount').addClass('is-invalid');
      isValid = false;
    } else {
      $('#discountAmount').removeClass('is-invalid');
    }

    // Validate dates
    const startDateObj = new Date(startDate);
    const endDateObj = new Date(endDate);

    if (!startDate || isNaN(startDateObj)) {
      $('#startDate').addClass('is-invalid');
      $('#startDateFeedback').text('Please enter a valid start date.');
      isValid = false;
    } else if (!isEditMode && startDateObj <= today) {
      $('#startDate').addClass('is-invalid');
      $('#startDateFeedback').text('Start date must be after today.');
      isValid = false;
    } else {
      $('#startDate').removeClass('is-invalid');
    }

    if (!endDate || isNaN(endDateObj)) {
      $('#endDate').addClass('is-invalid');
      $('#endDateFeedback').text('Please enter a valid end date.');
      isValid = false;
    } else if (endDateObj <= today) {
      $('#endDate').addClass('is-invalid');
      $('#endDateFeedback').text('End date must be after today.');
      isValid = false;
    } else if (endDateObj <= startDateObj) {
      $('#endDate').addClass('is-invalid');
      $('#endDateFeedback').text('End date must be after start date.');
      isValid = false;
    } else {
      $('#endDate').removeClass('is-invalid');
    }

    return isValid;
  }

  function resetModal() {
    $('#offerModalLabel').text('Add Offer');
    $('#offerForm')[0].reset();
    $('#offerModal .modal-footer .btn-primary').text('Add Offer').attr('onclick', 'saveOffer()');
    $('#offerModal').removeData('id');
  }

  function getInt(val,errorVal){
    try{
      return Integer.parseInt(val);
    }catch (e){
      console.warn(e);
      return errorVal;
    }
  }

  function saveOffer() {
    const isEditMode = !!$('#offerModal').data('id');
    if (!validateForm(isEditMode)) {
      return;
    }
    const offer = {
      name: $('#offerName').val(),
      discount: $('#discountAmount').val(),
      startDate: $('#startDate').val(),
      endDate: $('#endDate').val()
    };

    const url = $('#offerModal').data('id') ? `/api/admin/offer/${$('#offerModal').data('id')}` : '/api/admin/offer';
    const method = $('#offerModal').data('id') ? 'PUT' : 'POST';

    $.ajax({
      url: url,
      type: method,
      contentType: 'application/json',
      data: JSON.stringify(offer),
      success: function() {
        $('#offersTable').DataTable().ajax.reload();
        $('#offerModal').modal('hide');
      },
      error: function() {
        alert('Error saving offer');
      }
    });
  }

  function editOffer(id) {
    $.get(`/api/admin/offer/${id}`, function(rowData) {
      $('#offerModalLabel').text('Edit Offer');
      $('#offerName').val(rowData.name);
      $('#discountAmount').val(rowData.discount);
      $('#startDate').val(rowData.startDate);
      $('#endDate').val(rowData.endDate);
      $('#offerModal').data('id', id);
      $('#offerModal .modal-footer .btn-primary').text('Update Offer').attr('onclick', 'saveOffer()');
      $('#offerModal').modal('show');
    });
  }

  function toggleActive(id, isActive) {
    $.ajax({
      url: `/api/admin/offer/${id}/active`,
      type: 'PATCH',
      contentType: 'application/json',
      data: JSON.stringify(isActive),
      success: function() {
        $('#offersTable').DataTable().ajax.reload();
      },
      error: function() {
        alert('Error toggling active status');
      }
    });
  }

  function deleteOffer(id) {
    if (confirm('Are you sure you want to delete this offer?')) {
      $.ajax({
        url: `/api/admin/offer/${id}`,
        type: 'DELETE',
        success: function() {
          $('#offersTable').DataTable().ajax.reload();
        },
        error: function() {
          alert('Error deleting offer');
        }
      });
    }
  }

  function refreshTable() {
    $('#offersTable').DataTable().ajax.reload();
  }
</script>

<!-- Luxury Theme JavaScript -->
<script src="/js/luxury-theme.js"></script>
<script src="/js/luxury-theme-enhancer.js"></script>

</body>
</html>
